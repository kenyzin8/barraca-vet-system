<script>
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

function showError(message) {
    $('#errorModal .modal-body').text(message);
    $('#errorModal').modal('show');
}

function showSuccess(message) {
    $('#successModal .modal-body').text(message);
    $('#successModal').modal('show');
}

function formatDates(date) {
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const day = String(date.getDate()).padStart(2, '0');
    const monthIndex = date.getMonth();
    const year = date.getFullYear();

    return monthNames[monthIndex] + ' ' + day + ', ' + year;
}

function formatStringDate(dateString) {
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    const parts = dateString.split('-');
    const year = parts[0];
    const month = parts[1] - 1;
    const day = parts[2];

    const date = new Date(year, month, day);

    return monthNames[date.getMonth()] + ' ' + String(date.getDate()).padStart(2, '0') + ', ' + year;
}

function getEventCounts(events) {
    const eventCounts = {};

    events.forEach(event => {
        const date = FullCalendar.formatDate(event.start, {
            timeZone: 'local',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
        eventCounts[date] = (eventCounts[date] || 0) + 1;
    });

    return eventCounts;
}

function getInitialView() {
    return window.innerWidth <= 576 ? 'listMonth' : 'dayGridMonth';
}

function showRebookList() {
    var rebookList = document.getElementById('external-events-list');
    //console.log(rebookList.children.length);
    if (rebookList.children.length > 0) {
        document.getElementById('external-events').style.display = 'block';
    }
}

function hideRebookList() {
    var rebookList = document.getElementById('external-events-list');
    if (rebookList.children.length === 0) {
        document.getElementById('external-events').style.display = 'none';
    }
}

function showAppointmentDetails(appointmentId) {
    let appointment = document.getElementById(appointmentId);

    let client = appointment.getAttribute('data-client-name');
    let pet = appointment.getAttribute('data-pet-rname');
    let purpose = appointment.getAttribute('data-purpose-val');
    let timeOfDay = appointment.getAttribute('data-time-of-day')

    timeOfDay = timeOfDay.charAt(0).toUpperCase() + timeOfDay.slice(1);

    const details = [
        `<strong>Client:</strong> ${client}`,
        `<strong>Pet:</strong> ${pet}`,
        `<strong>Time of the Day:</strong> ${timeOfDay}`,
        purpose == null || purpose == "" ? `<strong>Purpose:</strong> None` : `<strong>Purpose:</strong> ${purpose}`
    ].join('<br>');

    document.getElementById('rebookListAppointmentLabel').innerText = "#" + appointmentId + " from Rebook List";
    document.getElementById('rebookListAppointmentBody').innerHTML = details;

    document.getElementById('doneRebookList').onclick = function() {
        $('#rebookListAppointmentModal').modal('hide');
        $('#doneAppointmentModal').modal('show');
    };

    document.getElementById('yesDoneAppointmentButton').onclick = function() {
        $('#doneAppointmentModal').modal('hide');

        $.ajax({
            type: 'POST',
            url: '{% url "mark_as_done" %}',
            data: {
                'appointment_id': appointmentId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'Appointment marked as done successfully.') {
                    appointment.remove();
                    $('#doneAppointmentModal').modal('hide');
                    showSuccess(response.status);
                    hideRebookList();
                } else {
                    showError(response.message);
                }
            },
            error: function(error) {
                showError(error.responseJSON.message);
            }
        });
    };

    var cancelDoneAppointmentButton = document.getElementsByClassName('cancelDoneAppointmentButton');
    for (var i = 0; i < cancelDoneAppointmentButton.length; i++) {
        cancelDoneAppointmentButton[i].onclick = function() {
            $('#doneAppointmentModal').modal('hide');
            $('#rebookListAppointmentModal').modal('show');
        };
    }

    document.getElementById('deleteRebookList').onclick = function() {
        $('#rebookListAppointmentModal').modal('hide');
        $('#deleteAppointmentModal').modal('show');
    };

    document.getElementById('yesDeleteAppointmentButton').onclick = function() {
        var reason = document.getElementById('cancel-appointment-reason').value;
        if(reason == ""){
            deleteAppointmentModal.hide();
            showError("Please enter a reason for cancellation.");
    
            $('#OKErrorModalButton').on('click', function() {
                $('#errorModal').modal('hide');
                deleteAppointmentModal.show();
            });
            return;
        }
        
        $.ajax({
            type: 'POST',
            url: '{% url "cancel_appointment" %}',
            data: {
                'appointment_id': appointmentId,
                'reason': $('#cancel-appointment-reason').val(),
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'Appointment cancelled successfully') {
                    appointment.remove();
                    $('#deleteAppointmentModal').modal('hide');
                    showSuccess(response.status + '.');
                    hideRebookList();
                    // location.reload();
                }
            },
            error: function(error) {
                $('#deleteAppointmentModal').modal('hide');
                showError(error.responseJSON.message);
            }
        });
    };

    var cancelDeleteAppointmentButton = document.getElementsByClassName('cancelDeleteAppointmentButton');
    for (var i = 0; i < cancelDeleteAppointmentButton.length; i++) {
        cancelDeleteAppointmentButton[i].onclick = function() {
            $('#deleteAppointmentModal').modal('hide');
            $('#rebookListAppointmentModal').modal('show');
        };
    }


    $('#rebookListAppointmentModal').modal('show');
}

function _showAppointmentDetails(event) {
    let appointment = document.getElementById(event.id);

    let client = event.extendedProps.client;
    let pet = event.extendedProps.pet;
    let purpose = event.extendedProps.purpose;
    let timeOfDay = event.extendedProps.timeOfTheDay;

    timeOfDay = timeOfDay.charAt(0).toUpperCase() + timeOfDay.slice(1);

    //alert(purpose)
    const details = [
        `<strong>Client:</strong> ${client}`,
        `<strong>Pet:</strong> ${pet}`,
        `<strong>Time of the Day:</strong> ${timeOfDay}`,
        purpose == null || purpose == "" ? `<strong>Purpose:</strong> None` : `<strong>Purpose:</strong> ${purpose}`
    ].join('<br>');

    document.getElementById('rebookListAppointmentLabel').innerText = "#" + event.id + " from Rebook List";
    document.getElementById('rebookListAppointmentBody').innerHTML = details;

    document.getElementById('doneRebookList').onclick = function() {
        $('#rebookListAppointmentModal').modal('hide');
        $('#doneAppointmentModal').modal('show');
    };

    document.getElementById('yesDoneAppointmentButton').onclick = function() {
        $('#doneAppointmentModal').modal('hide');

        $.ajax({
            type: 'POST',
            url: '{% url "mark_as_done" %}',
            data: {
                'appointment_id': event.id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'Appointment marked as done successfully.') {
                    appointment.remove();
                    $('#doneAppointmentModal').modal('hide');
                    showSuccess(response.status);
                    hideRebookList();
                    // location.reload();
                }
            },
            error: function(error) {
                showError(error.responseJSON.message);
            }
        });
    };

    var cancelDoneAppointmentButton = document.getElementsByClassName('cancelDoneAppointmentButton');
    for (var i = 0; i < cancelDoneAppointmentButton.length; i++) {
        cancelDoneAppointmentButton[i].onclick = function() {
            $('#doneAppointmentModal').modal('hide');
            $('#rebookListAppointmentModal').modal('show');
        };
    }

    document.getElementById('deleteRebookList').onclick = function() {
        $('#rebookListAppointmentModal').modal('hide');
        $('#deleteAppointmentModal').modal('show');
    };

    document.getElementById('yesDeleteAppointmentButton').onclick = function() {
        var reason = document.getElementById('cancel-appointment-reason').value;
        if(reason == ""){
            deleteAppointmentModal.hide();
            showError("Please enter a reason for cancellation.");
    
            $('#OKErrorModalButton').on('click', function() {
                $('#errorModal').modal('hide');
                deleteAppointmentModal.show();
            });
            return;
        }
        $.ajax({
            type: 'POST',
            url: '{% url "cancel_appointment" %}',
            data: {
                'appointment_id': event.id,
                'reason': $('#cancel-appointment-reason').val(),
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'Appointment cancelled successfully') {
                    appointment.remove();
                    $('#deleteAppointmentModal').modal('hide');
                    showSuccess(response.status + ".");
                    hideRebookList();
                    // location.reload();
                }
            },
            error: function(error) {
                $('#deleteAppointmentModal').modal('hide');
                showError(error.responseJSON.message);
            }
        });
    };

    var cancelDeleteAppointmentButton = document.getElementsByClassName('cancelDeleteAppointmentButton');
    for (var i = 0; i < cancelDeleteAppointmentButton.length; i++) {
        cancelDeleteAppointmentButton[i].onclick = function() {
            $('#deleteAppointmentModal').modal('hide');
            $('#rebookListAppointmentModal').modal('show');
        };
    }


    $('#rebookListAppointmentModal').modal('show');
}

function updateSlots(info, dateString, dateSlots, maxAppointments, allAppointments, slotElements) {
    {% comment %} console.log(`Info: ${info}` + info);
    console.log(info);
    console.log(`Date String: ${dateString}`);
    console.log(dateString);
    console.log(`Date Slots: ${dateSlots}`);
    console.log(dateSlots);
    console.log(`Max Appointments: ${maxAppointments}`);
    console.log(maxAppointments);
    console.log(`All Appointments: ${allAppointments}`);
    console.log(allAppointments);
    console.log(`Slot Elements: ${slotElements}`);
    console.log(slotElements); {% endcomment %}
    
    
    var oldDate = new Date(info.oldEvent.start);
    var oldDateString = oldDate.getFullYear() + '-' + String(oldDate.getMonth() + 1).padStart(2, '0') + '-' + String(oldDate.getDate()).padStart(2, '0');
    
    if (info.type != "from_rebook_list") {
        var oldEventCount = allAppointments.filter(function(event) {
            var _date = new Date(event.start);
            var _formattedDate = _date.getFullYear() + '-' + (_date.getMonth() + 1).toString().padStart(2, '0') + '-' + _date.getDate().toString().padStart(2, '0');
            return _formattedDate === oldDateString;
        }).length;

        var oldSlots = (dateSlots[oldDateString] || maxAppointments);

        //console.log(slotElements[oldDateString].textContent.split('/').map(Number));
        var [currentUsedSlots, totalSlots] = slotElements[oldDateString].textContent.split('/').map(Number);

        if (oldEventCount < oldSlots) {
            currentUsedSlots++;
        }

        slotElements[oldDateString].textContent = `${currentUsedSlots}/${oldSlots}`;
    }

    if (info.type != "mark_done") {
        var newEventCount = allAppointments.filter(function(event) {
            var _date = new Date(event.start);
            var _formattedDate = _date.getFullYear() + '-' + (_date.getMonth() + 1).toString().padStart(2, '0') + '-' + _date.getDate().toString().padStart(2, '0');
            return _formattedDate === dateString;
        }).length;

        var newSlots = (dateSlots[dateString] || maxAppointments);

        var newDateStringSlotElement = slotElements[dateString].textContent;
        slotElements[dateString].textContent = `${newSlots - newEventCount}/${newSlots}`;
    }
}

function updateTimeOfTheDayCell(date, timeOfDayInfo, timeOfTheDayElements) {
    var timeOfTheDayElement = timeOfTheDayElements[date];

    var _info = timeOfDayInfo[date];

    // console.log(_info.el.classList.contains('day-disabled-whole-day'));
    // console.log(_info.el.classList.contains('day-disabled-morning'));
    // console.log(_info.el.classList.contains('day-disabled-afternoon'));
    // console.log(_info.el.classList.contains('day-disabled-full'));
    // console.log(_info.el.classList.contains('day-available'));

    _info.el.querySelector('.fc-daygrid-day-top').removeChild(timeOfTheDayElement);

    if (_info.el.classList.contains('day-disabled-whole-day')) {
        timeOfTheDayElement.textContent = `Disabled`;
    }

    if (_info.el.classList.contains('day-disabled-morning')) {
        timeOfTheDayElement.textContent = `Afternoon Available`;
    }

    if (_info.el.classList.contains('day-disabled-afternoon')) {
        timeOfTheDayElement.textContent = `Morning Available`;
    }

    if (_info.el.classList.contains('day-full')) {
        timeOfTheDayElement.textContent = `Full`;
    }

    if (_info.el.classList.contains('day-available')) {
        timeOfTheDayElement.textContent = ``;
    }

    _info.el.querySelector('.fc-daygrid-day-top').appendChild(timeOfTheDayElement);
}

function updateTimeOfTheDayCellRebook(date, oldDate, timeOfDayInfo, timeOfTheDayElements) {

    function updateTimeOfTheDayCell(date, oldDate) {
        if (timeOfTheDayElements[date] && timeOfDayInfo[date]) {
            var timeOfTheDayElement = timeOfTheDayElements[date];
            var _info = timeOfDayInfo[date];
            //console.log(date, _info.el.classList);
            // console.log(_info.el.classList.contains('day-disabled-whole-day'));
            // console.log(_info.el.classList.contains('day-disabled-morning'));
            // console.log(_info.el.classList.contains('day-disabled-afternoon'));
            // console.log(_info.el.classList.contains('day-full'));

            _info.el.querySelector('.fc-daygrid-day-top').removeChild(timeOfTheDayElement);

            if (_info.el.classList.contains('day-available')) {
                timeOfTheDayElement.textContent = ``;
            }

            if (_info.el.classList.contains('day-disabled-whole-day')) {
                timeOfTheDayElement.textContent = `Disabled`;
            }

            if (_info.el.classList.contains('day-disabled-morning')) {
                timeOfTheDayElement.textContent = `Afternoon Available`;
            }

            if (_info.el.classList.contains('day-disabled-afternoon')) {
                timeOfTheDayElement.textContent = `Morning Available`;
            }

            if (_info.el.classList.contains('day-full')) {
                timeOfTheDayElement.textContent = `Full`;
            }

            _info.el.querySelector('.fc-daygrid-day-top').appendChild(timeOfTheDayElement);
        }

        if (oldDate && timeOfTheDayElements[oldDate] && timeOfDayInfo[oldDate]) {
            var oldTimeOfTheDayElement = timeOfTheDayElements[oldDate];
            var _oldInfo = timeOfDayInfo[oldDate];
            //console.log(oldDate, _oldInfo.el.classList);

            _oldInfo.el.querySelector('.fc-daygrid-day-top').removeChild(oldTimeOfTheDayElement);

            if (_oldInfo.el.classList.contains('day-available')) {
                oldTimeOfTheDayElement.textContent = ``;
            }

            if (_oldInfo.el.classList.contains('day-disabled-whole-day')) {
                oldTimeOfTheDayElement.textContent = `Disabled`;
            }

            if (_oldInfo.el.classList.contains('day-disabled-morning')) {
                oldTimeOfTheDayElement.textContent = `Afternoon Available`;
            }

            if (_oldInfo.el.classList.contains('day-disabled-afternoon')) {
                oldTimeOfTheDayElement.textContent = `Morning Available`;
            }

            if (_oldInfo.el.classList.contains('day-full')) {
                oldTimeOfTheDayElement.textContent = `Full`;
            }

            _oldInfo.el.querySelector('.fc-daygrid-day-top').appendChild(oldTimeOfTheDayElement);
        }
    }

    updateTimeOfTheDayCell(date, oldDate);

    if (oldDate) {
        updateTimeOfTheDayCell(oldDate);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    var debugcounter = 0;
    var appointmentIdToMarkDone;
    var timeOfTheDayElements = {};
    var timeOfDayInfo = {};
    var slotElements = {};

    const datatablesSimple = document.getElementById('datatablesSimple');
    var dataTable = null;

    var max_page = 0;

    if (datatablesSimple) {
        dataTable = new simpleDatatables.DataTable(datatablesSimple, {
            paging: true,
            perPageSelect: [5, 8, 10, 25],
            perPage: 8,
            fixedHeight: true,
            sortable: true,
            searchable: true,
            hiddenHeader: false,
        });

        dataTable.on('datatable.update', () => {
            feather.replace();

            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        dataTable.on('datatable.page', function(page) {
            feather.replace();

            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        dataTable.on('datatable.search', function(query, matched) {
            feather.replace();

            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        dataTable.on('datatable.sort', function(column, direction) {
            feather.replace();

            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        var searchInput = document.querySelector('.datatable-input');

        searchInput.addEventListener('search', function(e) {
            if (e.target.value == '') {
                dataTable.search('');
            }
        });
    }

    $.ajax({
        type: 'GET',
        url: '{% url "get_all_data" %}',
        dataType: 'json',
        success: function(response) {
            var allAppointments = response.appointments;

            var disabledDays = response.disabled_days;

            var maxAppointments = response.max_appointments;

            var allPets = response.all_pets;
            var allClients = response.all_clients;

            let parameter = new URLSearchParams(window.location.search);
            let _pet_id = parameter.get('pet_id');
            let _owner_id = parameter.get('owner_id');
        
            if (_pet_id && _owner_id) {
                var petExists = allPets.some((pet) => pet.id == _pet_id);
                var ownerExists = allClients.some((client) => client.id == _owner_id);
                if (!petExists || !ownerExists) {
                    parameter.delete('pet_id');
                    parameter.delete('owner_id');
                    _owner_id = null;
                    _pet_id = null;
                    history.pushState({}, null, location.pathname);
                }
            }

            $('#id_client').change(function() {
                var url = "{% url 'get_pets' %}";
                var clientId = $(this).val();
                $.ajax({
                    url: url,
                    data: {
                        'client_id': clientId
                    },
                    success: function(data) {
                        var select = $("#id_pet");
                        select.html('');
                        $.each(data, function(index, text) {
                            select.append(
                                $('<option></option>').val(text.id).html(text.name)
                            );
                        });
                        if (_pet_id) {
                            $('#id_pet').val(_pet_id);
                        }
                    }
                });
            });
        
            if(_owner_id != null && _pet_id != null) {
                $('#id_client').val(_owner_id);
                $('#id_client').trigger('change');
            }

            var dateSlotsMap = response.date_slots.reduce((map, slot) => {
                map[slot.date] = slot;
                return map;
            }, {});

            var dateSlots = {};

            for (let date in dateSlotsMap) {
                dateSlots[date] = dateSlotsMap[date].morning_slots + dateSlotsMap[date].afternoon_slots;
            }
            
            disabledDays.forEach(disabledDay => {
                if (dateSlots.hasOwnProperty(disabledDay.date)) {
                    var morning_slots = dateSlotsMap[disabledDay.date].morning_slots;
                    var afternoon_slots = dateSlotsMap[disabledDay.date].afternoon_slots;
                            
                    switch (disabledDay.timeOfTheDay) {
                        case 'whole_day':
                            morning_slots = 0;
                            afternoon_slots = 0;
                            break;
                        case 'morning':
                            morning_slots = 0;
                            break;
                        case 'afternoon':
                            afternoon_slots = 0;
                            break;
                        default:
                            break;
                    }
            
                    dateSlots[disabledDay.date] = morning_slots + afternoon_slots;
                } else {
                    if (!dateSlots.hasOwnProperty(disabledDay.date)) {
                        switch (disabledDay.timeOfTheDay) {
                            case 'whole_day':
                                dateSlots[disabledDay.date] = 0;
                                break;
                            case 'morning':
                                dateSlots[disabledDay.date] = maxAppointments / 2; // Only afternoon
                                break;
                            case 'afternoon':
                                dateSlots[disabledDay.date] = maxAppointments / 2; // Only morning
                                break;
                            default:
                                dateSlots[disabledDay.date] = maxAppointments; // If it doesn't match any condition, default to maxAppointments
                                break;
                        }
                    }
                }
            });
            
            var calendarEl = document.getElementById('calendar');
            var containerEl = document.getElementById('external-events-list');
            new FullCalendar.Draggable(containerEl, {
                itemSelector: '.fc-event',
                droppable: true,
                // eventDragStart: function(info) {
                //     alert(info)
                // },
                eventData: function(eventEl) {
                    return {
                        title: eventEl.innerText.trim()
                    }
                }
            });

            var calendar = new FullCalendar.Calendar(calendarEl, {
                themeSystem: 'bootstrap5',
                eventOrder: 'none',
                lazyFetching: true,
                progressiveEventRendering: true,
                views: {
                    listDay: {
                        buttonText: 'Day'
                    },
                    dayGridMonth: {
                        buttonText: 'Month'
                    },
                    multiMonthYear: {
                        buttonText: 'Year'
                    },
                    listYear: {
                        buttonText: 'All'
                    },
                    listMonth: {
                        buttonText: 'List Month'
                    }
                },
                buttonText: {
                    today: 'Today',
                },
                allDayText: '',
                firstDay: 1,
                noEventsText: 'No appointments to show',
                initialDate: getCurrentDateString(),
                initialView: getInitialView(),
                navLinks: true, // can click day/week names to navigate views
                selectable: true,
                selectMirror: true,
                editable: true,
                droppable: true,
                dayMaxEvents: false, // allow "more" link when too many events
                height: 'auto',
                hiddenDays: [0],
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true,
                    meridiem: 'long'
                },
                events: allAppointments,
                navLinkDayClick: function(date, jsEvent) {
                    {% include 'admin/script/navLinkDayClick.js' %}
                },
                select: function(arg) {
                    {% include 'admin/script/select.js' %}
                },
                loading: function(isLoading) {
                    {% include 'admin/script/loading.js' %}
                },
                eventClick: function(arg) {
                    {% include 'admin/script/eventClick.js' %}
                },
                eventDrop: function(info) {
                    {% include 'admin/script/eventDrop.js' %}
                },
                drop: function(arg) {
                    {% include 'admin/script/drop.js' %}
                },
                dayCellClassNames: function(info) {
                    {% include 'admin/script/dayCellClassNames.js' %}
                },
                eventDidMount: function(info) {
                    {% comment %} {% include 'admin/script/eventDidMount.js' %} {% endcomment %}
                },
                dayCellDidMount: function(info) {
                    {% include 'admin/script/dayCellDidMount.js' %}
                },
                selectAllow: function(selectInfo) {
                    {% include 'admin/script/selectAllow.js' %}
                },
                eventAdd: function(addInfo) {
                    calendar.refetchEvents();
                },
                eventReceive: function(info) {
                    info.revert();
                },
                dayCellContent: function(arg) {
                    return {
                        html: `${arg.dayNumberText}`
                    }
                },
            });

            $('#addAppointmentModal').on('hidden.bs.modal', function(e) {
                $('#id_timeOfTheDay option[value="morning"]').show();
                $('#id_timeOfTheDay option[value="afternoon"]').show();
                $('#id_timeOfTheDay').val('morning');
                $("#id_purpose").off("change");
            });

            $('#rebookConfirmAppointmentModal').on('hidden.bs.modal', function(e) {
                $('#id_timeOfTheDay-rebook option[value="morning"]').show();
                $('#id_timeOfTheDay-rebook option[value="afternoon"]').show();
                $('#id_timeOfTheDay-rebook').val('morning');
                $("#id_purpose-rebook").off("change");
            });

            $('#enableDayModal').on('hidden.bs.modal', function(e) {
                $('#id_timeOfTheDay option[value="morning"]').show();
                $('#id_timeOfTheDay option[value="afternoon"]').show();
                $('#id_timeOfTheDay').val('morning');
            });

            $('#yesEnableDayModalButton').click(function(e) {
                e.preventDefault();

                let date = $('#selectedDateToEnable').val();

                $.ajax({
                    type: 'POST',
                    url: '{% url "enable_day" %}',
                    data: {
                        'date': date,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#enableDayModal').modal('hide');

                            const indexToRemove = disabledDays.findIndex(day => day.date === date);
                            if (indexToRemove !== -1) {
                                disabledDays.splice(indexToRemove, 1);
                            }

                            calendar.render();

                            updateTimeOfTheDayCell(date, timeOfDayInfo, timeOfTheDayElements);
                            showSuccess(response.message);

                            $('#OKSuccessModalButton').on('click', function() {
                                var currentView = calendar.view;
                                localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                                location.reload();
                            });
                            // var currentView = calendar.view;
                            // localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                            // location.reload();
                        }
                    },
                    error: function(error) {
                        $('#enableDayModal').modal('hide');
                        showError(error.responseJSON.message);
                    }
                });
            });

            $('#enable-day-choice').click(function() {
                $('#dayChoiceModal').modal('hide');
                $('#enableDayModal').modal('show');
            });

            $('#disable-day-choice').click(function() {
                $('#dayChoiceModal').modal('hide');

                let date = window.selectedDate;
                let dateString = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');

                $('#selectedDateToDisable').val(dateString);

                $('#disableDayModal').modal('show');
            });

            function createRebookEvent(event) {
                var rebookList = document.getElementById('external-events-list');
                var rebookEvent = document.createElement('div');
                rebookEvent.classList.add('fc-event', 'fc-h-event', 'fc-daygrid-event', 'fc-daygrid-block-event', 'custom-rebook-color');
                rebookEvent.id = event.id;
            
                rebookEvent.dataset.clientId = event.extendedProps.client_id;
                rebookEvent.dataset.clientName = event.extendedProps.client;
                rebookEvent.dataset.petId = event.extendedProps.pet_id;
                rebookEvent.dataset.petName = event.extendedProps.pet;
                rebookEvent.dataset.purposeId = event.extendedProps.purpose_id;
                rebookEvent.dataset.purposeVal = event.extendedProps.purpose;
                rebookEvent.dataset.timeOfDay = event.extendedProps.timeOfTheDay_val;
                rebookEvent.dataset.daySmsSent = event.extendedProps.day_sms_reminder;
                rebookEvent.dataset.weekSmsSent = event.extendedProps.week_sms_reminder;
                rebookEvent.dataset.contactNumber = event.extendedProps.contact_number;
                rebookEvent.dataset.currentDate = event.extendedProps.current_date;
            
                rebookEvent.onclick = function() {
                    _showAppointmentDetails(event);
                };
            
                var eventMainDiv = document.createElement('div');
                eventMainDiv.classList.add('fc-event-main');
                eventMainDiv.innerHTML = '#' + event.id + ' - ' + event.extendedProps.client;
                rebookEvent.appendChild(eventMainDiv);
                rebookList.appendChild(rebookEvent);
            }
            
            function sortEventsForDate(calendar, targetDateStr) {
                let targetDate = new Date(targetDateStr);
            
                let eventsForDate = calendar.getEvents().filter(event => {
                    return event.start.getFullYear() === targetDate.getFullYear() &&
                           event.start.getMonth() === targetDate.getMonth() &&
                           event.start.getDate() === targetDate.getDate();
                });
            
                eventsForDate.sort((a, b) => {
                    if (a.start < b.start) return -1;
                    if (a.start > b.start) return 1;
                    return 0;
                });
            
                eventsForDate.forEach(event => event.remove());
                
                eventsForDate.forEach(event => {
                    calendar.addEvent(event.toPlainObject());
                });
            }
            
            
            $('#disableDayForm').on('submit', function(e) {
                e.preventDefault();

                let formData = $(this).serialize();

                $.ajax({
                    type: 'POST',
                    url: '{% url "disable_day" %}',
                    data: formData,
                    success: function(response) {
                        if (response.status === 'success') {
                            $('#disableDayModal').modal('hide');
                            disabledDays.push(response.disabled_day);

                            calendar.render();
                            // var currentView = calendar.view;
                            // localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                            // location.reload();
                            
                            var datesOnCell = window.eventsOnSelectedDay;
                            var dateString;
                            var isEventOnCell = false;

                            datesOnCell.forEach(event => {
                                if(response.disabled_day.timeOfTheDay == 'morning' && event.extendedProps.timeOfTheDay_val == 'morning') {
                                    dateString = event.extendedProps.current_date;
                                    dateString = new Date(dateString);
                                    createRebookEvent(event);
                                    event.remove();
                                    
                                    var index = allAppointments.findIndex((_event) => {
                                        return Number(_event.id) === Number(event.id);
                                    });

                                    if (index > -1) {
                                        allAppointments.splice(index, 1);
                                    }

                                    isEventOnCell = true;
                                } else if(response.disabled_day.timeOfTheDay == 'afternoon' && event.extendedProps.timeOfTheDay_val == 'afternoon') {
                                    dateString = event.extendedProps.current_date;
                                    dateString = new Date(dateString);
                                    createRebookEvent(event);
                                    event.remove();

                                    var index = allAppointments.findIndex((_event) => {
                                        return Number(_event.id) === Number(event.id);
                                    });

                                    if (index > -1) {
                                        allAppointments.splice(index, 1);
                                    }

                                    isEventOnCell = true;
                                } else if(response.disabled_day.timeOfTheDay == 'whole_day') {
                                    dateString = event.extendedProps.current_date;
                                    dateString = new Date(dateString);
                                    createRebookEvent(event);
                                    event.remove();

                                    var index = allAppointments.findIndex((_event) => {
                                        return Number(_event.id) === Number(event.id);
                                    });

                                    if (index > -1) {
                                        allAppointments.splice(index, 1);
                                    }
                                    isEventOnCell = true;
                                }
                            });

                            if(isEventOnCell)
                            {
                                dateString = dateString.getFullYear() + '-' + String(dateString.getMonth() + 1).padStart(2, '0') + '-' + String(dateString.getDate()).padStart(2, '0');
                                
                                var info = {
                                    event: {
                                        id: null
                                    },
                                    oldEvent: {
                                        start: dateString
                                    }
                                };
                                updateSlots(info, dateString, dateSlots, maxAppointments, allAppointments, slotElements);
                            }
                            


                            updateTimeOfTheDayCell(response.disabled_day.date, timeOfDayInfo, timeOfTheDayElements);
                            showRebookList();
                            showSuccess(`${response.disabled_day.date} has been disabled for ${response.disabled_day.timeOfTheDay}. Reason: ${response.disabled_day.reason}`);
                        
                            $('#OKSuccessModalButton').on('click', function() {
                                localStorage.setItem('calendarDate', response.disabled_day.date);
                                location.reload();
                            });
                        } else {
                            showError(response.message);
                        }
                    },
                    error: function(error) {
                        $('#disableDayModal').modal('hide');
                        showError(error.responseJSON.message);
                    }
                });
            });

            $('#adjust-slot-choice').click(function() {
                $('#dayChoiceModal').modal('hide');

                let date = window.selectedDate;
                let dateString = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');

                $('#selectedDateToDisable-slots').val(dateString);
                $('#maximum-appointments-allowed').text(maxAppointments/2);

                $('#id_morning_slots').val(maxAppointments/2);
                $('#id_afternoon_slots').val(maxAppointments/2);

                for(var i = 0; i < response.date_slots.length; i++) {
                    if(response.date_slots[i].date == dateString) {
                        $('#id_morning_slots').val(response.date_slots[i].morning_slots);
                        $('#id_afternoon_slots').val(response.date_slots[i].afternoon_slots);
                    }
                }

                $('#adjustSlotModal').modal('show');
            });

            $('#adjustSlotForm').submit(function(e) {
                e.preventDefault();

                let formData = $(this).serialize();

                $.ajax({
                    type: 'POST',
                    url: '{% url "adjust_slots" %}',
                    data: formData,
                    success: function(response) {
                        if (response.status === 'success') {
                            $('#adjustSlotModal').modal('hide');

                            var date = response.dateSlot.date;
                            var slots = response.dateSlot.morning_slots + response.dateSlot.afternoon_slots;
                            dateSlots[date] = slots;

                            var dateString = date;
                            var movedEventId = null;
                            var allAppointmentsForDate = allAppointments.filter(function(event) {
                                var _date = new Date(event.start);
                                var _formattedDate = _date.getFullYear() + '-' + (_date.getMonth() + 1).toString().padStart(2, '0') + '-' + _date.getDate().toString().padStart(2, '0');
                                return _formattedDate === dateString;
                            });
                            var info = {
                                event: {
                                    id: movedEventId
                                },
                                oldEvent: {
                                    start: dateString
                                }
                            };

                            updateSlots(info, dateString, dateSlots, maxAppointments, allAppointmentsForDate, slotElements);

                            showSuccess(response.message);

                            $('#OKSuccessModalButton').on('click', function() {
                                localStorage.setItem('calendarDate', response.dateSlot.date);
                                location.reload();
                            });

                        } else {
                            $('#adjustSlotModal').modal('hide');
                            showError(response.message + ".");
                        }
                    },
                    error: function(error) {
                        $('#adjustSlotModal').modal('hide');
                        showError(error.responseJSON.message);
                    }
                });
            });

            $('#cancelAdjustSlotModalButton').click(function(e) {
                e.preventDefault();
                $('#adjustSlotModal').modal('hide');
                $('#dayChoiceModal').modal('show');
            });

            $('#cancelAdjustSlotModalIconButton').click(function(e) {
                e.preventDefault();
                $('#adjustSlotModal').modal('hide');
                $('#dayChoiceModal').modal('show');
            });

            $('#add-appointment-day-choice').click(function() {
                $('#dayChoiceModal').modal('hide');
                let date = window.selectedDate;
                
                let dateString = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
                
                let currentDate = new Date();
                currentDate.setHours(0, 0, 0, 0);

                if (date < currentDate) {
                    showError('Cannot add appointments in the past.');
                    return;
                }

                $.ajax({
                    type: 'GET',
                    url: '{% url "check_if_full" %}',
                    data: {
                        'selected_date': dateString,
                    },
                    success: function(response) {
                        if (response.status === 'full') {
                            showError('This date is full, please refresh the page.');
                        } else {
                            $('#selectedDate').val(dateString);
                            $('#addAppointmentModal').modal('show');
                        }
                    },
                    error: function(error) {
                        showError(error.responseJSON.message);
                    }
                });
            });

            $('#addAppointmentModal').on('shown.bs.modal', function () {
                const updateBusyTimes = function() {
                    const selectedServiceId = $("#id_purpose").val();
                    const selectedDate = $("#selectedDate").val();

                    $('#id_time option').show();
                    $.ajax({
                        type: 'GET',
                        url: '{% url "check_if_full" %}',
                        data: {
                            'selected_date': selectedDate,
                        },
                        success: function(response) {
                            if (response.status === 'morning_full') {
                                $('#id_time option').each(function() {
                                    let time = $(this).val();
                                    if (time >= "07:30:00" && time < "12:00:00") {
                                        $(this).hide();
                                    }
                                });
                            } else if (response.status === 'afternoon_full') {
                                $('#id_time option').each(function() {
                                    let time = $(this).val();
                                    if (time >= "12:00:00" && time <= "17:59:00") { 
                                        $(this).hide();
                                    }
                                });
                            } 
                        },
                        error: function(error) {
                            showError(error.responseJSON.message);
                        }
                    });

                    if (selectedServiceId && selectedDate) {
                        $.ajax({
                            url: "{% url 'get-busy-times' %}", 
                            method: "GET",
                            data: {
                                service_id: selectedServiceId,
                                date: selectedDate
                            },
                            success: function(response) {
                                if (response.status === "success") {
                                    const busyTimes = response.busy_times;
        
                                    let disabledDay = disabledDays.find(function(day) {
                                        return day.date === selectedDate;
                                    });

                                    $('#id_time option').show();
        
                                    if (disabledDay) {
                                        if (disabledDay.timeOfTheDay === 'morning') {
                                            $('#id_time option').each(function() {
                                                const timeValue = $(this).val();
                                                if (timeValue < "12:00:00") {
                                                    $(this).hide();
                                                }
                                            });
                                        } else if (disabledDay.timeOfTheDay === 'afternoon') {
                                            $('#id_time option').each(function() {
                                                const timeValue = $(this).val();
                                                if (timeValue >= "12:00:00") {
                                                    $(this).hide();
                                                }
                                            });
                                        }
                                    } 

                                    busyTimes.forEach(function(time) {
                                        $("#id_time option[value='" + time + "']").hide();
                                    });

                                    var firstAvailableTime = $('#id_time option:visible:first').val();
                                    $('#id_time').val(firstAvailableTime);
                                }
                            },
                            error: function(error) {
                                showError("Failed to fetch busy times:", error);
                            }
                        });
                    }
                }
        
                updateBusyTimes();
        
                $("#id_purpose").change(updateBusyTimes);
            });

            $('#rebookConfirmAppointmentModal').on('shown.bs.modal', function () {
                const updateBusyTimes = function() {
                    const selectedServiceId = $("#id_purpose-rebook").val();
                    const selectedDate = window.newDate;
                    if (selectedServiceId && selectedDate) {
                        $.ajax({
                            url: "{% url 'get-busy-times' %}", 
                            method: "GET",
                            data: {
                                service_id: selectedServiceId,
                                date: selectedDate
                            },
                            success: function(response) {
                                if (response.status === "success") {
                                    const busyTimes = response.busy_times;
                                    let disabledDay = disabledDays.find(function(day) {
                                        return day.date === selectedDate;
                                    });
                
                                    $('#id_time-rebook option').show();

                                    if (disabledDay) {
                                        if (disabledDay.timeOfTheDay === 'morning') {
                                            $('#id_time-rebook option').each(function() {
                                                const timeValue = $(this).val();
                                                if (timeValue < "12:00:00") {
                                                    $(this).hide();
                                                }
                                            });
                                        } else if (disabledDay.timeOfTheDay === 'afternoon') {
                                            $('#id_time-rebook option').each(function() {
                                                const timeValue = $(this).val();
                                                if (timeValue >= "12:00:00") {
                                                    $(this).hide();
                                                }
                                            });
                                        }
                                    } 
                                    busyTimes.forEach(function(time) {
                                        $("#id_time-rebook option[value='" + time + "']").hide();
                                    });
                                    
                                    var firstAvailableTime = $('#id_time-rebook option:visible').not(":first").first().val();
                                    $('#id_time-rebook').val(firstAvailableTime);
                                }
                            },
                            error: function(error) {
                                showError("Failed to fetch busy times:", error);
                            }
                        });
                    }
                }
        
                updateBusyTimes();
        
                $("#id_purpose-rebook").change(updateBusyTimes);
            });
            
            $('#rebookAppointmentForm').submit(function(e) {
                e.preventDefault();
                
                var appointment_id = window.eventId;
                var new_date = window.newDate;
                var old_date = window.oldDate;
                var time_of_day = $('#id_timeOfTheDay-rebook').val();
                var time = $('#id_time-rebook').val();
                var pet = $('#id_pet-rebook').val();
                var purpose = $('#id_purpose-rebook').val();

                $.ajax({
                    type: 'POST',
                    url: '{% url "rebook_appointment" %}',
                    data: {
                        'appointment_id': appointment_id,
                        'new_date': new_date,
                        'time_of_day': time_of_day,
                        'time': time,
                        'pet': pet,
                        'purpose': purpose,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.status === 'Appointment rebooked successfully') {
                            var draggedEl = document.getElementById(response.appointment.id); //for rebook

                            var eventToRemove = calendar.getEventById(appointment_id);
                            if (eventToRemove) {
                                eventToRemove.remove();
                            }

                            var newEvent = {
                                id: response.appointment.id,
                                title: response.appointment.client.first_name + " " + response.appointment.client.last_name,
                                start: response.appointment.date + "T" + response.appointment.time,
                                color: response.appointment.color,
                                allDay: false,
                                extendedProps: {
                                    'client_id': response.appointment.client.id,
                                    'client': response.appointment.client.first_name + " " + response.appointment.client.last_name,
                                    'contact_number': response.appointment.client.contact_number,
                                    'pet': response.appointment.pet.name,
                                    'pet_id': response.appointment.pet.id,
                                    'timeOfTheDay': response.appointment.timeOfTheDay,
                                    'timeOfTheDay_val': response.appointment.timeOfTheDay_val,
                                    'time': response.appointment.time,
                                    'purpose': response.appointment.purpose,
                                    'purpose_id': response.appointment.purpose_id,
                                    'current_date': response.appointment.date,
                                    'day_sms_reminder': response.appointment.daily_reminder_sent,
                                    'week_sms_reminder': response.appointment.weekly_reminder_sent,
                                }
                            };
                            calendar.addEvent(newEvent);

                            if(draggedEl) {
                                draggedEl.parentNode.removeChild(draggedEl);
                                hideRebookList();
                            }
                            
                            // if (draggedEl) {
                            //     draggedEl.parentNode.removeChild(draggedEl);
                            //     hideRebookList();

                            //     var c = calendar.addEvent({
                            //         id: response.appointment.id,
                            //         title: response.appointment.client.first_name + " " + response.appointment.client.last_name,
                            //         start: response.appointment.date,
                            //         color: response.appointment.color,
                            //         extendedProps: {
                            //             'client_id': response.appointment.client.id,
                            //             'client': response.appointment.client.first_name + " " + response.appointment.client.last_name,
                            //             'contact_number': response.appointment.client.contact_number,
                            //             'pet': response.appointment.pet.name,
                            //             'pet_id': response.appointment.pet.id,
                            //             'timeOfTheDay': response.appointment.timeOfTheDay,
                            //             'timeOfTheDay_val': response.appointment.timeOfTheDay_val,
                            //             'purpose': response.appointment.purpose,
                            //             'purpose_id': response.appointment.purpose_id,
                            //             'current_date': response.appointment.date,
                            //             'day_sms_reminder': response.appointment.daily_reminder_sent,
                            //             'week_sms_reminder': response.appointment.weekly_reminder_sent,
                            //         }
                            //     });
                            // }

                            var _event = calendar.getEventById(response.appointment.id);

                            if (_event) {
                                _event.setProp('color', response.appointment.color);
                            }

                            if (old_date != "from_rebook_list") {
                                _event.setExtendedProp('client_id', response.appointment.client.id);
                                _event.setExtendedProp('client', response.appointment.client.first_name + " " + response.appointment.client.last_name);
                                _event.setExtendedProp('contact_number', response.appointment.client.contact_number);
                                _event.setExtendedProp('pet', response.appointment.pet.name);
                                _event.setExtendedProp('pet_id', response.appointment.pet.id);
                                _event.setExtendedProp('timeOfTheDay', response.appointment.timeOfTheDay);
                                _event.setExtendedProp('timeOfTheDay_val', response.appointment.timeOfTheDay_val);
                                _event.setExtendedProp('time', response.appointment.time);
                                _event.setExtendedProp('purpose', response.appointment.purpose);
                                _event.setExtendedProp('purpose_id', response.appointment.purpose_id);
                                _event.setExtendedProp('current_date', response.appointment.date);
                                _event.setExtendedProp('day_sms_reminder', response.appointment.daily_reminder_sent);
                                _event.setExtendedProp('week_sms_reminder', response.appointment.weekly_reminder_sent);

                                var info = {
                                    event: _event,
                                    oldEvent: {
                                        start: old_date
                                    }
                                };
                            } else {
                                var info = {
                                    event: _event,
                                    oldEvent: {
                                        start: old_date
                                    },
                                    type: "from_rebook_list"
                                };

                                allAppointments.push({
                                    id: response.appointment.id,
                                    title: response.appointment.client.first_name + " " + response.appointment.client.last_name,
                                    start: response.appointment.date + "T" + response.appointment.time,
                                    color: response.appointment.color,
                                    allDay: false,
                                    extendedProps: {
                                        'client_id': response.appointment.client.id,
                                        'client': response.appointment.client.first_name + " " + response.appointment.client.last_name,
                                        'contact_number': response.appointment.client.contact_number,
                                        'pet': response.appointment.pet.name,
                                        'pet_id': response.appointment.pet.id,
                                        'timeOfTheDay': response.appointment.timeOfTheDay,
                                        'timeOfTheDay_val': response.appointment.timeOfTheDay_val,
                                        'time': response.appointment.time,
                                        'purpose': response.appointment.purpose,
                                        'purpose_id': response.appointment.purpose_id,
                                        'current_date': response.appointment.date,
                                        'day_sms_reminder': response.appointment.daily_reminder_sent,
                                        'week_sms_reminder': response.appointment.weekly_reminder_sent,
                                    }
                                });

                            }

                            var dateString = new_date;
                            var movedEventId = info.event.id;

                            var startDate = new Date(newEvent.start);
                            var formattedNewStart = startDate.getFullYear() + '-' + 
                                String(startDate.getMonth() + 1).padStart(2, '0') + '-' + 
                                String(startDate.getDate()).padStart(2, '0');

                            for (var i = 0; i < allAppointments.length; i++) {
                                if (allAppointments[i].id == newEvent.id) {
                                    allAppointments[i] = newEvent; 
                                    allAppointments[i].start = formattedNewStart;
                                    break;
                                }
                            }
                           
                            updateSlots(info, dateString, dateSlots, maxAppointments, allAppointments, slotElements);

                            $('#rebookConfirmAppointmentModal').modal('hide');

                            showSuccess(response.status + ".");

                            var oldDate;
                            if (old_date == "from_rebook_list") {
                                oldDate = new Date("Wed Jul 26 2023 00:00:00 GMT+0800 (Philippine Standard Time)");
                            } else {
                                oldDate = old_date
                            }
                            var year = oldDate.getFullYear();
                            var month = (oldDate.getMonth() + 1).toString().padStart(2, '0');
                            var day = oldDate.getDate().toString().padStart(2, '0');
                            var formattedOldDate = year + '-' + month + '-' + day;

                            updateTimeOfTheDayCellRebook(dateString, formattedOldDate, timeOfDayInfo, timeOfTheDayElements);
                            sortEventsForDate(calendar, newEvent.start);
                        }

                        // var currentView = calendar.view;
                        // localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                        // location.reload();
                    },
                    error: function(error) {
                        $('#rebookConfirmAppointmentModal').modal('hide');
                        if(window.info){
                            window.info.revert();
                        }
                        showError(error.responseJSON.message);
                    }
                });
            });

            $('#appointmentForm').on('submit', function(e) {
                e.preventDefault();

                $.ajax({
                    type: 'POST',
                    url: '{% url "set_appointment" %}',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.success) {
                            var c = calendar.addEvent({
                                id: response.appointment.id,
                                title: response.appointment.client.first_name + " " + response.appointment.client.last_name,
                                start: response.appointment.date + "T" + response.appointment.time,
                                color: response.appointment.color,
                                allday: false,
                                extendedProps: {
                                    'client_id': response.appointment.client.id,
                                    'client': response.appointment.client.first_name + " " + response.appointment.client.last_name,
                                    'contact_number': response.appointment.client.contact_number,
                                    'pet': response.appointment.pet.name,
                                    'pet_id': response.appointment.pet.id,
                                    'timeOfTheDay': response.appointment.timeOfTheDay,
                                    'timeOfTheDay_val': response.appointment.timeOfTheDay_val,
                                    'time': response.appointment.time,
                                    'purpose': response.appointment.purpose,
                                    'purpose_id': response.appointment.purpose_id,
                                    'current_date': response.appointment.date,
                                    'day_sms_reminder': response.appointment.daily_reminder_sent,
                                    'week_sms_reminder': response.appointment.weekly_reminder_sent,
                                }
                            });

                           
                            var info = {
                                event: c,
                                oldEvent: {
                                    start: c.start
                                }
                            };

                            var dateString = response.appointment.date + "T" + response.appointment.time;

                            allAppointments.push({
                                id: response.appointment.id,
                                title: response.appointment.client.first_name + " " + response.appointment.client.last_name,
                                start: dateString,
                                color: response.appointment.color,
                                allDay: false,
                                extendedProps: {
                                    'client_id': response.appointment.client.id,
                                    'client': response.appointment.client.first_name + " " + response.appointment.client.last_name,
                                    'contact_number': response.appointment.client.contact_number,
                                    'pet': response.appointment.pet.name,
                                    'pet_id': response.appointment.pet.id,
                                    'timeOfTheDay': response.appointment.timeOfTheDay,
                                    'timeOfTheDay_val': response.appointment.timeOfTheDay_val,
                                    'time': response.appointment.time,
                                    'purpose': response.appointment.purpose,
                                    'purpose_id': response.appointment.purpose_id,
                                    'current_date': response.appointment.date,
                                    'day_sms_reminder': response.appointment.daily_reminder_sent,
                                    'week_sms_reminder': response.appointment.weekly_reminder_sent,
                                }
                            });

                            dateString = response.appointment.date.split("T")[0];
                            updateSlots(info, dateString, dateSlots, maxAppointments, allAppointments, slotElements);
                            updateTimeOfTheDayCell(dateString, timeOfDayInfo, timeOfTheDayElements);

                            sortEventsForDate(calendar, c.start);

                            calendar.unselect();

                            showSuccess(response.message + ".");

                            $('#addAppointmentModal').modal('hide');
                            // var currentView = calendar.view;
                            // localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                            // location.reload();
                        }
                    },
                    error: function(error) {
                        $('#addAppointmentModal').modal('hide');
                        showError(error.responseJSON.message);
                    }
                });
            });

            calendar.render();

            var calendarDate = localStorage.getItem('calendarDate');
            if (calendarDate) {
                calendar.gotoDate(new Date(calendarDate));
                localStorage.removeItem('calendarDate');
            }

            function updateCalendarOptions() {
                if (window.innerWidth <= 576) {
                    calendar.setOption('headerToolbar', {
                        left: 'title',
                        center: 'listDay,dayGridMonth,listMonth,listYear',
                        right: 'today prev,next'
                    });

                } else {
                    calendar.setOption('headerToolbar', {
                        left: 'today prev,next',
                        center: 'title',
                        right: 'listDay,dayGridMonth,multiMonthYear,listYear'
                    });
                }
            }

            updateCalendarOptions();

            function getCurrentDateString() {
                const currentDate = new Date();
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');

                return `${year}-${month}-${day}`;
            }

            if (_pet_id && _owner_id) {
                var petExists = allPets.some((pet) => pet.id == _pet_id);
                var ownerExists = allClients.some((client) => client.id == _owner_id);
                if (petExists || ownerExists) {
                    parameter.delete('pet_id');
                    parameter.delete('owner_id');
                    history.pushState({}, null, location.pathname);
                }
            }
        },
        error: function(error) {
            console.error(error);
        }
    });
});
</script>