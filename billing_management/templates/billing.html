{% extends 'admin_dashboard/base.html' %}

{% load static %}
{% load humanize %}

{% block title %} New Bill | Barraca Veterinary Clinic {% endblock %}

{% block extrastyles %}
<style>
    .invoice .table tbody tr td, .invoice .datatable-table tbody tr td 
    {
        padding-top: 0;
    }

    @media screen and (max-width: 600px) 
    {
        .table-responsive, .datatable-wrapper .datatable-container 
        {
            margin-top: -30px;
        }

        .table-responsive-modal
        {
            overflow-x: auto;
        }
    }
    .table-responsive, .datatable-wrapper .datatable-container 
    {
        margin-top: 0;
    }

    .billing-table
    {
        margin-top: -60px;
    }
</style>
<script>
    $(document).ready(function() {
        let dataTable_products;
        let dataTable_services;
        let dataTable_clients;
        
        $('#addClientModal').on('show.bs.modal', function (event) {
            const datatablesSimple_clients = document.getElementById('datatablesSimple-client');
            if (datatablesSimple_clients) {
                dataTable_clients = new simpleDatatables.DataTable(datatablesSimple_clients, {
                    paging: true,
                    perPageSelect: [5, 10, 25, 50],
                    perPage: 10,
                    sortable: true,
                    searchable: true,
                    hiddenHeader: false,
                });
            }
        });
        $('#addServiceModal').on('show.bs.modal', function (event) {
            const datatablesSimple_services = document.getElementById('datatablesSimple-services');
            if (datatablesSimple_services) {
                dataTable_services = new simpleDatatables.DataTable(datatablesSimple_services, {
                    paging: true,
                    perPageSelect: [5, 10, 25, 50],
                    perPage: 10,
                    sortable: true,
                    searchable: true,
                    hiddenHeader: false,
                });
            }
        });

        $('#addProductModal').on('show.bs.modal', function (event) {
            const datatablesSimple_products = document.getElementById('datatablesSimple-products');
            if (datatablesSimple_products) {
                dataTable_products = new simpleDatatables.DataTable(datatablesSimple_products, {
                    paging: true,
                    perPageSelect: [5, 10, 25, 50],
                    perPage: 10,
                    sortable: true,
                    searchable: true,
                    hiddenHeader: false,
                });
            }
        });

        $('#addClientModal').on('hidden.bs.modal', function (event) {
            if (dataTable_services) {
                dataTable_services.destroy();
                dataTable_services = null;
            }
        });

        $('#addServiceModal').on('hidden.bs.modal', function (event) {
            if (dataTable_clients) {
                dataTable_clients.destroy();
                dataTable_clients = null;
            }
        });

        $('#addProductModal').on('hidden.bs.modal', function (event) {
            if (dataTable_products) {
                dataTable_products.destroy();
                dataTable_products = null;
            }
        });
    });
</script>
    
{% endblock %}

{% block content %}
<div class="card invoice mt-5 mb-5 animated--fade-in">
    <div class="card-header p-4 p-md-5 border-bottom-0 bg-dark text-white-50">
        <div class="row justify-content-between align-items-center">
            <div class="col-12 col-lg-auto mb-5 mb-lg-0 text-center text-lg-start">
                <!-- Invoice branding-->
                <img class="invoice-brand-img rounded-circle mb-2" src="{% static 'images/billing.png' %}" alt=""/>
                <div class="h2 text-white mb-0">
                    Barraca
                </div>
                Veterinary Clinic
            </div>
            <div class="col-12 col-lg-auto text-center text-lg-end">
                <!-- Invoice details-->
                <div class="h3 text-white">Billing Statement</div>
                Bill No. <span class="billing-number">{{ next_bill_number }}</span>
                <br />
                <span class="current-date">{% now "F j, Y" %}</span>
            </div>
        </div>
    </div>

    <div class="card-body p-4 p-md-5">
        <div class="row" style="padding: 0.75rem 0.75rem;">
            <div class="col-md-6 col-lg-3 mb-lg-0">
                <!-- Invoice - sent to info-->
                <div class="small text-muted text-uppercase fw-700 mb-2">
                    Client
                    <a class="btn btn-datatable btn-icon btn-transparent-dark find-client-button" href="#addClientModal" data-bs-toggle="modal" data-bs-placement="top" title="Find Client">
                        <i data-feather="plus-circle"></i>
                    </a>
                </div>
                <div class="d-flex align-items-center">
                    <input type="text" class="form-control selected-client-input" data-client-id="{{ client.id }}" value="{{ client.full_name }}" id="" placeholder="Walk-in or select existing client">
                    &nbsp;
                    <a class="btn btn-datatable btn-icon btn-transparent-dark remove-client ml-2" href="#" data-bs-toggle="tooltip" data-bs-placement="top" title="Remove Client" style="display: none;">
                        <i data-feather="delete"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="card-body p-4 p-md-5">
        <!-- Invoice table-->
        <div class="table-responsive billing-table">
            <table class="table table-borderless mb-0">
                <thead class="">
                    <tr class="small text-uppercase text-muted">
                        <th scope="col">
                            Services 
                            <a class="btn btn-datatable btn-icon btn-transparent-dark" href="#addServiceModal" data-bs-toggle="modal" data-bs-placement="top" title="Add Service" id="addServiceBtn">
                                <i data-feather="plus-circle"></i>
                            </a>
                        </th>
                        <th class="text-end" scope="col"><!-- empty for spacing --></th>
                        <th class="text-end" scope="col"><!-- empty for spacing --></th>
                        <th class="text-end" scope="col">Amount</th>
                    </tr>
                </thead>
                <tbody class="tbody-services">
                    <!-- added service here -->
                </tbody>
            </table>
            <hr>
            <table class="table table-borderless mb-0 mt-4">
                <thead class="">
                    <tr class="small text-uppercase text-muted">
                        <th scope="col">
                            Products
                            <a class="btn btn-datatable btn-icon btn-transparent-dark" href="#addProductModal" data-bs-toggle="modal" data-bs-placement="top" title="Add Product">
                                <i data-feather="plus-circle"></i>
                            </a>
                        </th>
                        <th class="text-end" scope="col"><!-- empty for spacing --></th>
                        <th class="text-end" scope="col"><!-- empty for spacing --></th>
                        <th class="text-end" scope="col"><!-- empty for spacing --></th>
                    </tr>
                </thead>
                <tbody class="tbody-products">
                    <!-- added product here -->
                    <tr class="border-top" id="total-row">
                        <td class="text-end pb-0" colspan="3"><!-- empty for spacing --></td>
                        <td class="text-end pb-0 h5 mb-0 fw-700 total-amount" style="padding-top: 20px;">Total Amount: â‚± 0.00</td>
                    </tr>
                    <tr>
                        <td class="text-end pb-0" colspan="3"><!-- empty for spacing --></td>
                        <td class="text-end pb-0" style="padding-top: 20px;">
                            <a href="{% url 'billing-page' %}" id="cancel-button" type="button" class="btn btn-danger lift lift-sm">Cancel</a>
                            <a href="#" id="paid-button" type="button" class="btn btn-success lift lift-sm">Paid</a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addClientModal" tabindex="-1" role="dialog" aria-labelledby="addClientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addClientModalLabel">Add Client</h5>
                <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div>
                    <table id="datatablesSimple-client">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Client</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for client in clients %}
                            <tr>
                                <td><span class="client-id">{{ client.id }}</span></td>
                                <td><span class="client-value">{{ client.full_name }}</span></td>
                                <td><button class="btn btn-dark add-client" data-client-id="{{ client.id }}">Add</button></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-dark" type="button" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addServiceModal" tabindex="-1" role="dialog" aria-labelledby="addServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServiceModalLabel">Add Service</h5>
                <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div>
                    <table id="datatablesSimple-services">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Service</th>
                                <th>Fee</th>
                                <th>Remarks</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for service in services %}
                            <tr>
                                <td>{{ service.id }}</td>
                                <td>
                                    <span class="service-type">
                                        {{ service.service_type }}
                                    </span>
                                </td>
                                <td>
                                    <span class="service-fee">
                                        â‚± {{ service.fee|intcomma }}
                                    </span>
                                </td>
                                <td>
                                    <span class="service-remarks">
                                        {{ service.get_remarks_display }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-dark add-service" data-service-id="{{ service.id }}">
                                        Add
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-dark" type="button" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">Add Product</h5>
                <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div>
                    <table id="datatablesSimple-products">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Product Name</th>
                                <th>Type</th>
                                <th>Expiration Date</th>
                                <th>Stock Quantity</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr>
                                <td>{{ product.id }}</td>
                                <td>
                                    <span class="product-name">
                                        {{ product.product_name }}
                                    </span>
                                </td>
                                <td>
                                    <span class="product-type">
                                        {{ product.type.name }}
                                    </span>
                                </td>
                                {% if product.is_product_expired %}
                                    <td>{{ product.expiration_date }} <span style="color: red;">(Expired)</span></td>
                                {% else %}
                                    <td>{{ product.expiration_date }}</td>
                                {% endif %}
                                <td>
                                    <span class="product-stock-quantity">
                                        {{ product.quantity_on_stock|floatformat:2|intcomma }}
                                    </span>
                                </td>
                                <td>
                                    <input type="number" class="form-control product-quantity" min="1" step="0.01" value="1" style="width: 80px;">
                                </td>
                                <td>
                                    <span class="product-price">
                                        â‚± {{ product.price|intcomma }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-dark add-product" data-product-id="{{ product.id }}" data-product-price="{{ product.price }}">
                                        Add
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-dark" type="button" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="addBillSuccess" tabindex="-1" role="dialog" aria-labelledby="addBillSuccessLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBillSuccessLabel">Success</h5>
                <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Billing <span class="billing-number-modal">{{ next_bill_number }}</span> has been submitted. Click <a href="{% url 'view-bill-page' next_bill_number %}">here</a> to view.
            </div>
            <div class="modal-footer">
                <button id="success-add-billing" class="btn btn-dark" type="button" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
                <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
               Are you sure you want to submit this billing statement?
            </div>
            <div class="modal-footer">
                <button class="btn btn-dark" type="button" data-bs-dismiss="modal">No</button>
                <button id="confirm-paid-button" class="btn btn-dark" type="button" data-bs-dismiss="modal">Yes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Error</h5>
                <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
               
            </div>
            <div class="modal-footer">
                <button class="btn btn-dark" type="button" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extrascripts %}
<script src="{% static 'plugins/sb-admin/js/datatables/simple-datatables.js' %}"></script>
<script src="{% static 'js/billing/billing.js' %}"></script>
{% endblock %}
