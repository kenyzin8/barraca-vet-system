{% extends 'admin_dashboard/base.html' %}

{% load static %}

{% block title %} Calendar | Barraca Veterinary Clinic {% endblock %}

{% block extrastyles %}
<link rel="stylesheet" href="{% static 'css/calendar/fullcalendar-custom.css' %}">
<script src="{% static 'plugins/fullcalendar/js/index.global.js' %}"></script>
<!-- <script src="{% static 'js/calendar/fullcalendar-settings.js' %}"></script> -->
<script src="{% static 'plugins/sb-admin/js/datatables/simple-datatables.js' %}"></script>
<!-- <script src="{% static 'plugins/sb-admin/js/datatables/my-datatable-setting.js' %}"></script> -->
<script src="{% static 'plugins/jQuery/jquery-3.6.4.min.js' %}"></script>
<script src="{% static 'js/sms/send_sms.js' %}"></script>
{% endblock %}

{% block content %}
<div class="calendar-container mt-4">
    <div class="card mb-5 card-collapsable card-waves animated--fade-in-up ">
        <a class="card-header" href="#collapseCardExample" data-bs-toggle="collapse" role="button" aria-expanded="true" aria-controls="collapseCardExample">
                Calendar
          <div class="card-collapsable-arrow">
              <i class="fas fa-chevron-down"></i>
          </div>
        </a>
        <div class="collapse show" id="collapseCardExample">
          <div class="card-body animated--fade-in-up flex-container">
            <div class="parent-container">
                
                <div id='external-events' {% if not rebook_appointments %} style="display: none;"{% endif %}>
                    <div class="height-wrapper">
                        <h4>Rebook List</h4>
                        <div id='external-events-list'>
                            {% if rebook_appointments %}
                            {% for appointment in rebook_appointments %}
                                <div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event custom-rebook-color' id='{{ appointment.id }}' data-client-id="{{ appointment.client.id }}" data-pet-id="{{ appointment.pet.id }}" data-purpose-id="{{ appointment.purpose.id }}" data-time-of-day="{{ appointment.timeOfTheDay }}">
                                    <div class='fc-event-main'>#{{ appointment.id }} - {{ appointment.client.full_name }}</div>
                                </div>
                            {% endfor %}
                            {% else %}
                            <span class="small"><< Empty >></span>
                            {% endif %}
                        </div>
                        <p>
                            <span>View an appointment and click rebook to add here. <br><br><br>Note that dropping only works for <b>Month</b> and <b>Year</b> calendar view.</span>
                        </p>
                    </div>
                </div>
                
                <div id='calendar-wrap'>
                    <div id='calendar'></div>
                </div>
            </div>
          </div>
          <div class="card-footer small text-muted">Legend: <span style="color: #3788d8;">Morning</span> | <span style="color: green">Afternoon</span> | <span style="color: darkorange">Pending Rebook</span></div>
        </div>
      </div>
</div>

<div class="card mb-4 appointment-table" hidden>
    <div class="card-header">
        <span class="appointment-table-title">August 5, 2020 | Appointments</span>
    </div>
    <div class="card-body">
        <table id="datatablesSimple" class="appointments-list-table">
            <thead>
                <tr>
                    <th>Appointment Number</th>
                    <th>Name</th>
                    <th>Contact Number</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
        <button type="button" class="btn btn-warning btn-sm lift lift-sm" onclick="confirmSendBulkSMS()">Notify All</button>&nbsp;&nbsp;<span style="font-size: 12px;"><i>Only the visible rows will be notified</i></span>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true" data-bs-backdrop='static'>
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="eventModalLabel">
             <!-- Event start will be displayed here -->
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="eventModalBody">
          <!-- Event title will be displayed here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark btn-sm" id="deleteEvent">Cancel Appointment</button>
          <button type="button" class="btn btn-dark btn-sm" id="rebookEvent">Rebook</button>
          <button type="button" class="btn btn-dark btn-sm" data-bs-dismiss="modal">OK</button>
      </div>
      </div>
    </div>
</div>  

<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true" data-bs-backdrop='static'>
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="confirmationModalLabel">Send SMS Confirmation</h5>
            <button id="close-sms-confirmation-button" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            Are you sure you want to remind this client?<br><br>
            <b>Name:</b> <span id="clientName"></span><br>
            <b>Phone Number:</b> <span id="clientPhoneNumber"></span>
        </div>
        <div class="modal-footer">
            <button id="cancelSMSButton" type="button" class="btn btn-dark btn-sm" data-bs-dismiss="modal">Cancel</button>
            <button id="sendSMSButton" type="button" class="btn btn-success btn-sm" onclick="sendSMS(document.getElementById('hiddenClientPhone').value, document.getElementById('hiddenAppointmentID').value)">
                Yes
                <span id="smsSendingSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
            </button>
        </div>
        </div>
    </div>
</div>   

<div class="modal fade" id="bulkConfirmationModal" tabindex="-1" aria-labelledby="bulkConfirmationModalLabel" aria-hidden="true" data-bs-backdrop='static'>
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkConfirmationModalLabel">Send Bulk SMS Confirmation</h5>
                <button id="closeBulkSMSButton" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bulk-modal-body">
                Are you sure you want to send SMS reminders to all clients?
            </div>
            <div class="modal-footer">
                <button id="cancelBulkSMSButton" type="button" class="btn btn-dark btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button id="sendBulkSMSButton" type="button" class="btn btn-success btn-sm" onclick="sendBulkSMS()">
                    Yes
                    <span id="bulkSMSSendingSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
</div> 

<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true" data-bs-backdrop='static'>
    <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
        <div class="modal-header">
        <h5 class="modal-title" id="messageModalLabel">SMS Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="messageModalBody">
        </div>
        <div class="modal-footer">
        <button type="button" class="btn btn-dark btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
    </div>
    </div>
</div>

<div class="modal fade" id="addAppointmentModal" tabindex="-1" aria-labelledby="addAppointmentModal" aria-hidden="true" data-bs-backdrop='static'>
    <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
        <div class="modal-header">
        <h5 class="modal-title" id="addAppointmentModalLabel">Add Appointment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="addAppointmentModalBody">
            <form method="POST" id="appointmentForm">
                {% csrf_token %}
                {{ form.as_p }}
                <input type="hidden" id="selectedDate" name="date">

        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-dark btn-sm" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-dark btn-sm">Submit</button>
            </form>
        </div>
    </div>
    </div>
</div>

<div class="modal fade" id="deleteAppointmentModal" tabindex="-1" aria-labelledby="deleteAppointmentModalLabel" aria-hidden="true" data-bs-backdrop='static'>
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="deleteAppointmentModalLabel">Cancel Appointment Confirmation</h5>
            <button id="close-sms-confirmation-button" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            Are you sure you want to cancel this appointment?<br><br>
        </div>
        <div class="modal-footer">
            <button id="cancelDeleteAppointmentButton" type="button" class="btn btn-dark btn-sm" data-bs-dismiss="modal">No</button>
            <button id="yesDeleteAppointmentButton" type="button" class="btn btn-danger btn-sm">
                Yes
            </button>
        </div>
        </div>
    </div>
</div> 

<div class="modal fade" id="rebookConfirmAppointmentModal" tabindex="-1" aria-labelledby="rebookConfirmAppointmentModalLabel" aria-hidden="true" data-bs-backdrop='static'>
    <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
        <div class="modal-header">
        <h5 class="modal-title" id="rebookConfirmAppointmentModalLabel">Rebook Appointment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="rebookConfirmAppointmentModalBody">
            <p><b>Client:</b> <span id="clientName-rebook"></span></p>
            <form method="POST" id="rebookAppointmentForm">
                {% csrf_token %}
                {{ rebook_form.as_p }}
                <input type="hidden" id="selectedDate" name="date">
                <p><b>Old Date:</b> <span id="oldDate"></span></p>
                <p><b>New Date:</b> <span id="newDate"></span></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-dark btn-sm" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-dark btn-sm">Submit</button>
            </form>
        </div>
    </div>
    </div>
</div>

<input id="hiddenClientPhone" value="" hidden>
<input id="hiddenAppointmentID" value="" hidden>
<div id="sms-data" data-url="{% url 'send_sms_to_client' %}"></div>

{% endblock %}

{% block extrascripts %}
<script>

function formatDates(date) {
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const day = String(date.getDate()).padStart(2, '0');
    const monthIndex = date.getMonth();
    const year = date.getFullYear();

    return monthNames[monthIndex] + ' ' + day + ', ' + year;
}

function getEventCounts(events) {
    const eventCounts = {};

    events.forEach(event => {
        const date = FullCalendar.formatDate(event.start, {
            timeZone: 'local',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
        eventCounts[date] = (eventCounts[date] || 0) + 1;
    });

    return eventCounts;
}

function toLocalDate(date) {
    var localOffset = date.getTimezoneOffset() * 60000;
    var localTime = date.getTime();
    var utcTime = localTime - localOffset;
    var targetDate = new Date(utcTime);
    var dd = String(targetDate.getDate()).padStart(2, '0');
    var mm = String(targetDate.getMonth() + 1).padStart(2, '0'); //January is 0!
    var yyyy = targetDate.getFullYear();
    return yyyy + '-' + mm + '-' + dd;
}

function getInitialView() {
    return window.innerWidth <= 576 ? 'listYear' : 'dayGridMonth';
}

document.addEventListener('DOMContentLoaded', function() {
    const datatablesSimple = document.getElementById('datatablesSimple');
    var dataTable = null;
    if (datatablesSimple) {
        dataTable = new simpleDatatables.DataTable(datatablesSimple, {
            paging: true,
            perPageSelect: [5, 10, 25, 50],
            perPage: 10,
            fixedHeight: true,
            sortable: true,
            searchable: true,
            hiddenHeader: false,
        });

        dataTable.on('datatable.update', () => {
            feather.replace();
            
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        dataTable.on('datatable.page', function(page) {
            feather.replace();
            
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        dataTable.on('datatable.search', function(query, matched) {
            feather.replace();

            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        dataTable.on('datatable.sort', function(column, direction) {
            feather.replace();
            
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });

        var searchInput = document.querySelector('.datatable-input');
        
        searchInput.addEventListener('search', function(e) {
            if (e.target.value == '') {
                dataTable.search('');
            }
        });
    }

    var calendarEl = document.getElementById('calendar');
    var containerEl = document.getElementById('external-events-list');
    new FullCalendar.Draggable(containerEl, {
        itemSelector: '.fc-event',
        eventData: function(eventEl) {
            return {
                title: eventEl.innerText.trim()
            }
        }
    });

    var calendar = new FullCalendar.Calendar(calendarEl, {
        themeSystem: 'bootstrap5',
        eventOrder: 'none',
        lazyFetching: true,
        progressiveEventRendering: true,
        views: {
            listDay: {
                buttonText: 'Day'
            },
            dayGridMonth: {
                buttonText: 'Month'
            },
            multiMonthYear: {
                buttonText: 'Year'
            },
            listYear: {
                buttonText: 'All'
            },
            listMonth: {
                buttonText: 'Month'
            }
        },
        buttonText: {
            today: 'Today',
        },
        allDayText: '',
        firstDay: 1,
        noEventsText: 'No appointments to show',
        initialDate: getCurrentDateString(),
        initialView: getInitialView(),
        navLinks: true, // can click day/week names to navigate views
        selectable: true,
        selectMirror: true,
        editable: true,
        droppable: true,
        dayMaxEvents: false, // allow "more" link when too many events
        hiddenDays: [0],
        select: function(arg) {

            let date = arg.start;
            let dateString = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');

            $.ajax({
                type: 'POST',
                url: '{% url "check_if_full" %}',
                data: {
                    'selected_date': dateString,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'full') {
                        alert('This date is full.');
                    } else {
                        $('#selectedDate').val(dateString);
                        $('#addAppointmentModal').modal('show');
                    }
                },
                error: function(error) {
                    console.log(error);
                }
            });
        },
        eventClick: function(arg) {

            var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
            const dateString = arg.event.start;
            const date = new Date(dateString);
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const day = monthNames[date.getMonth()] + " " + date.getDate() + ", " + date.getFullYear();

            const details = [
                `Client: ${arg.event.extendedProps.client}`,
                `Pet: ${arg.event.extendedProps.pet}`,
                `Time of the Day: ${arg.event.extendedProps.timeOfTheDay}`,
                `Purpose: ${arg.event.extendedProps.purpose}`
            ].join('\n');

            document.getElementById('eventModalLabel').innerText = "#" + arg.event.id + " - " + day;
            document.getElementById('eventModalBody').innerText = details;
            eventModal.show();

            var popover = document.querySelector('.fc-popover');
            if (popover) {
                popover.style.display = 'none';
            }

            var deleteAppointmentModal = new bootstrap.Modal(document.getElementById('deleteAppointmentModal'));

            document.getElementById('deleteEvent').onclick = function() {
                deleteAppointmentModal.show();
            };

            document.getElementById('yesDeleteAppointmentButton').onclick = function() {
                $.ajax({
                    type: 'POST',
                    url: '{% url "cancel_appointment" %}',
                    data: {
                        'appointment_id': arg.event.id,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.status === 'Appointment cancelled successfully') {
                            arg.event.remove();
                            eventModal.hide();
                            deleteAppointmentModal.hide();
                        }
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            };

            document.getElementById('rebookEvent').onclick = function() {
                $.ajax({
                    type: 'POST',
                    url: '{% url "add_to_rebook_list" %}',
                    data: {
                        'appointment_id': arg.event.id,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.status === 'Appointment rebooked successfully') {
                            arg.event.remove();
                            eventModal.hide();

                            var currentView = calendar.view;
                            localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                            location.reload();
                        }
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            };
        },

        events: "{% url 'get_appointments' %}",
        dayCellClassNames: function(info) {
            const eventCounts = getEventCounts(calendar.getEvents());
            const date = FullCalendar.formatDate(info.date, {
                timeZone: 'local',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            if (eventCounts[date] === 8) {
                return ['day-full'];
            } else {
                return ['day-available'];
            }
            alert(eventCounts[date])
        },
        navLinkDayClick: function(date, jsEvent) {
            jsEvent.preventDefault();

            var events = calendar.getEvents(); 
            var dateStr = date.toISOString(); 

            var eventsOnDate = events.filter(function(event) {
                return event.start.toISOString().substring(0, 10) === dateStr.substring(0, 10);
            });

            if (eventsOnDate.length === 0) {
                return;
            }

            $(".appointment-table-title").text(formatDates(date) + ' | Appointments');
            $(".appointment-table").removeAttr("hidden");

            dataTable.rows.remove([0, 1, 2, 3, 4, 5, 6, 7])

            eventsOnDate.forEach(function(event, index) {
                var row = [
                    event.id,
                    event.extendedProps.client,
                    event.extendedProps.contact_number,
                    "<button type='button' class='btn btn-primary btn-sm lift lift-sm' onclick='confirmSendSMS(\"" +
                        event.id + "\", \"" +
                        event.extendedProps.client + "\", \"" +
                        event.extendedProps.contact_number + "\"" +
                    ")'>Notify</button>"
                ];
                dataTable.rows.add(row);  // Add the row
            });

            $('html, body').animate({
                scrollTop: $(".appointments-list-table").offset().top
            }, 100);
        },
        selectAllow: function(selectInfo) {
            var dayBeforeEndDate = new Date(selectInfo.end);
            dayBeforeEndDate.setDate(dayBeforeEndDate.getDate() - 1);
            return FullCalendar.formatDate(selectInfo.start, {
                timeZone: 'local',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }) === FullCalendar.formatDate(dayBeforeEndDate, {
                timeZone: 'local',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        },
        eventDrop: function(info) {
            let date = info.event.start;
            let dateString = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');

            $.ajax({
                type: 'POST',
                url: '{% url "check_if_full" %}',
                data: {
                    'selected_date': dateString,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'full') {
                        alert('This date is full.');
                        info.revert();
                    } else {
                        info.revert();
                        $('#clientName-rebook').text(info.event.extendedProps.client);
                        $('#oldDate').text(info.event.extendedProps.current_date);
                        $('#newDate').text(dateString);
                        $('#rebookConfirmAppointmentModal').modal('show');
                        var start = info.event.start;
                        var dateObj = new Date(start.getTime() - (start.getTimezoneOffset() * 60000));
                        var date = dateObj.toISOString().slice(0, 10);

                        window.eventId = info.event.id;
                        window.newDate = date;

                        var url = "{% url 'get_pets' %}";
                        var clientId = info.event.extendedProps.client_id;
                        var select_pet = $("#id_pet-rebook");
                        $.ajax({
                            url: url,
                            data: {
                                'client_id': clientId
                            },
                            success: function(data) {
                                
                                select_pet.html('');
                                $.each(data, function(index, text) {
                                    select_pet.append(
                                        $('<option></option>').val(text.id).html(text.name)
                                    );
                                });
                                select_pet.val(info.event.extendedProps.pet_id);
                            }
                        });

                        var select_purpose = $("#id_purpose-rebook");
                        select_purpose.val(info.event.extendedProps.purpose_id);

                        var select_timeOfDay = $("#id_timeOfTheDay-rebook");
                        select_timeOfDay.val(info.event.extendedProps.timeOfTheDay_val);
                    }
                },
                error: function(error) {
                    console.log(error);
                }
            });
        },
        drop: function(arg) {
            // from rebook list
            $.ajax({
                type: 'POST',
                url: '{% url "check_if_full" %}',
                data: {
                    'selected_date': arg.dateStr,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'full') {
                        alert('This date is full.');
                    } else {
                        $('#clientName-rebook').text(arg.draggedEl.innerText);
                        $('#oldDate').text("From Rebook List");
                        $('#newDate').text(arg.dateStr);
                        $('#rebookConfirmAppointmentModal').modal('show');

                        window.eventId = arg.draggedEl.id;
                        window.newDate = arg.dateStr;

                        var clientId = arg.draggedEl.dataset.clientId;
                        var petId = arg.draggedEl.dataset.petId;
                        var purposeId = arg.draggedEl.dataset.purposeId;
                        var timeOfDay = arg.draggedEl.dataset.timeOfDay;
                        var url = "{% url 'get_pets' %}";

                        $.ajax({
                            url: url,
                            data: {
                                'client_id': clientId
                            },
                            success: function(data) {
                                var select = $("#id_pet-rebook");
                                select.html('');
                                $.each(data, function(index, text) {
                                    select.append(
                                        $('<option></option>').val(text.id).html(text.name)
                                    );
                                });
                            }
                        });

                        var select_purpose = $("#id_purpose-rebook");
                        select_purpose.val(purposeId);

                        var select_timeOfDay = $("#id_timeOfTheDay-rebook");
                        select_timeOfDay.val(timeOfDay);
                    }
                },
                error: function(error) {
                    console.log(error);
                }
            });
        },
        eventReceive: function(info) {
            info.revert();
        },
    });

    $('#rebookAppointmentForm').submit(function(e) {
        e.preventDefault();

        var appointment_id = window.eventId;
        var new_date = window.newDate;
        var time_of_day = $('#id_timeOfTheDay-rebook').val();
        var pet = $('#id_pet-rebook').val();
        var purpose = $('#id_purpose-rebook').val();

        $.ajax({
            type: 'POST',
            url: '{% url "rebook_appointment" %}',
            data: {
                'appointment_id': appointment_id,
                'new_date': new_date,
                'time_of_day': time_of_day,
                'pet': pet,
                'purpose': purpose,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'Appointment rebooked successfully') {
                    var draggedEl = document.getElementById(appointment_id);
                    if (draggedEl) {
                        draggedEl.parentNode.removeChild(draggedEl);
                    }
                }

                $('#rebookConfirmAppointmentModal').modal('hide');
                var currentView = calendar.view;
                localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                location.reload();
            },
            error: function(error) {
                console.log(error);
            }
        });
    });


    $('#appointmentForm').on('submit', function(e) {
        e.preventDefault();

        $.ajax({
            type: 'POST',
            url: '{% url "set_appointment" %}',
            data: $(this).serialize(),
            success: function(response) {
                if (response.message === 'Appointment created successfully') {
                    var title = $('#id_client option:selected').text();

                    calendar.addEvent({
                        title: title,
                        start: $('#selectedDate').val(),
                        allDay: true
                    });
                    calendar.unselect();
                    $('#addAppointmentModal').modal('hide');
                    var currentView = calendar.view;
                    localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                    location.reload();
                }
            },
            error: function(error) {
                console.log(error);
            }
        });
    });
    calendar.render();

    var calendarDate = localStorage.getItem('calendarDate');
    if (calendarDate) {
        calendar.gotoDate(new Date(calendarDate));
        localStorage.removeItem('calendarDate');
    }

    function updateCalendarOptions() {
        if (window.innerWidth <= 576) {
            calendar.setOption('headerToolbar', {
                left: 'title',
                center: 'listMonth,listYear',
                right: 'today prev,next'
            });

        } else {
            calendar.setOption('headerToolbar', {
                left: 'today prev,next',
                center: 'title',
                right: 'listDay,dayGridMonth,multiMonthYear,listYear'
            });
        }
    }

    updateCalendarOptions();

    function getCurrentDateString() {
        const currentDate = new Date();
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed, so add 1
        const day = String(currentDate.getDate()).padStart(2, '0');

        return `${year}-${month}-${day}`;
    }
});
</script>
<script>
    $(document).ready(function() {
        $('#id_client').change(function() {
            var url = "{% url 'get_pets' %}";
            var clientId = $(this).val();
            $.ajax({
                url: url,
                data: {
                    'client_id': clientId
                },
                success: function (data) {
                    var select = $("#id_pet");
                    select.html('');
                    $.each(data, function(index, text) {
                        select.append(
                            $('<option></option>').val(text.id).html(text.name)
                        );
                    });
                }
            });
        });
    });
</script>
{% endblock %}
