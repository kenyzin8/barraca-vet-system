<script>
    let ind = {{ laboratory_results|length }};
    let labResultsData = [];

    function preventDecimal(event) {
        return ![69, 190, 188].includes(event.keyCode);
    }
    
    function removeDecimal(inputElement) {
        inputElement.value = inputElement.value.replace('.', '');
    }

    function uploadImage(inputElement, progressBarInner) {
        var formData = new FormData();
        formData.append('image', inputElement.files[0]);

        const currentInputID = inputElement.dataset.id; 

        $.ajax({
            url: "{% url 'admin-upload-lab-image-page' %}", 
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress", function(evt) {
                    if (evt.lengthComputable) {
                        var percentComplete = evt.loaded / evt.total;
                        percentComplete = parseInt(percentComplete * 100);

                        progressBarInner.style.width = percentComplete + '%';
                        progressBarInner.setAttribute('aria-valuenow', percentComplete);
                        progressBarInner.textContent = percentComplete + '%';

                        if (percentComplete === 100) {
                            progressBarInner.classList.remove('progress-bar-striped');
                            progressBarInner.classList.remove('progress-bar-animated');
                            progressBarInner.classList.remove('bg-warning');
                            progressBarInner.classList.add('bg-success');
                        }
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                labResultsData.push({
                    id: currentInputID,
                    image_id: response.temp_image_id
                });
                // console.log(labResultsData)
            },
            error: function(response) {
                showError("Error uploading image. Please try again.");
                inputElement.value = '';
                progressBarInner.style.width = 0 + '%';
                progressBarInner.setAttribute('aria-valuenow', 0);
                progressBarInner.textContent = 0 + '%';

                progressBarInner.classList.remove('bg-warning', 'bg-success');
                progressBarInner.classList.add('bg-danger');
            }
        });
    }

    function validateFile(input, progressBarInner) {
        var allowedExtensions = /(\.jpg|\.jpeg|\.png|\.webp)$/i;

        if(!allowedExtensions.exec(input.value)) {
            showError('Invalid file type. Only .jpg, .jpeg, and .png files are allowed.');
            input.value = '';
            return false;
        }
        else
        {
            uploadImage(input, progressBarInner);
            return true;
        }
    }

    function showSuccess(message)
    {
        $('#successModal .modal-body-success-message').text(message);
        $('#successModal').modal('show');
    }

    function showError(message)
    {
        $('#errorModal .modal-body').text(message);
        $('#errorModal').modal('show');
    }
    
    window.addEventListener('DOMContentLoaded', event => {

        let selectedPetName = "{{ pet_treatment.pet.name }}";
        let selectedPetId = "{{ pet_treatment.pet.id }}";
        selectedPetId = parseInt(selectedPetId);

        let selectedProductIds = new Set();
        let productsSelected = new Map();

        {% for pids in product_ids %}
        selectedProductIds.add({{ pids }});
        {% endfor %}

        {% for product_id, product_details in products_map.items %}
        productsSelected.set({{ product_id }}, {
            strength: "{{ product_details.strength }}",
            quantity: "{{ product_details.quantity }}",
            dosage: "{{ product_details.dosage }}",
            frequency: "{{ product_details.frequency }}",
            remarks: "{{ product_details.remarks }}"
        });
        {% endfor %}

        let radioStates = {};
        
        let inputTreatment = document.getElementById('inputTreatment');
        let radios = document.querySelectorAll('input[type="radio"]');
        
        radios.forEach(radio => {
            radio.addEventListener('click', function() {
                if (radioStates[this.id]) {
                    this.checked = false;
                    inputTreatment.value = ''; 
                    delete radioStates[this.id];
                } else {
                    radioStates[this.id] = true;
                    
                    radios.forEach(innerRadio => {
                        if (innerRadio.id !== this.id) {
                            innerRadio.checked = false;
                            delete radioStates[innerRadio.id];
                        }
                    });

                    if (this.id === 'dewormingRadio') {
                        inputTreatment.value = 'Deworming';
                    } else if (this.id === 'vaccRadio') {
                        inputTreatment.value = 'Vaccination';
                    }
                }
            });
        });

        $(document).on('change', '.lab-result-select', function() {
            var container = $(this).closest('.lab-result-group-fields');
            
            var selectedText = $('option:selected', this).text();
            var capitalizedText = selectedText.charAt(0).toUpperCase() + selectedText.slice(1);

            container.find('.lab-result-input').val(capitalizedText);

            var selectedUnit = $('option:selected', this).val();
            
            container.find('.lab-test-unit').text(selectedUnit == 'None' ? '' : selectedUnit);
        });
        
        const petTable = document.getElementById('petTable');
    
        if (petTable) {
            let dataTable = new simpleDatatables.DataTable(petTable, {
                paging: true,
                perPageSelect: [5, 10, 25, 50],
                perPage: 10,
                fixedHeight: true,
                sortable: true,
                searchable: true,
                hiddenHeader: false,
            });
    
            window.dataTable = dataTable;
    
            dataTable.on('datatable.update', () => {
                feather.replace();
                
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                })
                setupSelectButtons();
            });
    
            dataTable.on('datatable.page', function(page) {
                feather.replace();
                
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                })
                setupSelectButtons();
            });
    
            dataTable.on('datatable.search', function(query, matched) {
                feather.replace();
    
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                })

                console.log(selectedPetId)

                setupSelectButtons();
            });
    
            dataTable.on('datatable.sort', function(column, direction) {
                feather.replace();
                
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                })
                setupSelectButtons();
            });
    
            var searchInput = document.querySelector('.datatable-input');
            
            searchInput.addEventListener('search', function(e) {
                if (e.target.value == '') {
                    dataTable.search('');
                    setupSelectButtons();
                }
            });
        }
    
        const nextButtons = document.querySelectorAll('.next-button');
        const previousButtons = document.querySelectorAll('.previous-button');
        const navLinks = document.querySelectorAll('.nav-item.nav-link');
    
        function activateTab(tabIndex) {
            if (tabIndex >= 0 && tabIndex < navLinks.length) {
                navLinks[tabIndex].click();
            }
        }

        function updateButtonState(tabIndex) {
            if (tabIndex === navLinks.length - 1) {
                nextButtons.forEach(btn => {
                    btn.classList.add('disabled');
                    btn.setAttribute('disabled', true);
                });
            } else {
                nextButtons.forEach(btn => {
                    btn.classList.remove('disabled');
                    btn.removeAttribute('disabled');
                });
            }
        
            if (tabIndex === 0) {
                previousButtons.forEach(btn => {
                    btn.classList.add('disabled');
                    btn.setAttribute('disabled', true);
                });
            } else {
                previousButtons.forEach(btn => {
                    btn.classList.remove('disabled');
                    btn.removeAttribute('disabled');
                });
            }
        }

        function navigateTabs(direction) {
            const activeTab = document.querySelector('.nav-item.nav-link.active');
            const activeTabIndex = [...navLinks].indexOf(activeTab);
            const targetTabIndex = activeTabIndex + direction;
            
            activateTab(targetTabIndex);
            updateButtonState(targetTabIndex);
        }
    
        nextButtons.forEach(button => {
            button.addEventListener('click', () => {
                navigateTabs(1);
            });
        });
    
        previousButtons.forEach(button => {
            button.addEventListener('click', () => {
                navigateTabs(-1);
            });
        });
    
        function setupSelectButtons() {
            const selectPetButtons = document.querySelectorAll('.select-pet-button');

            function deselectAllPets() {
                selectPetButtons.forEach(button => {
                    const textSpan = button.querySelector('span');
                    if (textSpan.textContent === 'Selected') {
                        textSpan.textContent = 'Select';
                        textSpan.style.color = 'rgba(33, 40, 50, 0.5)';
                        textSpan.style.fontWeight = '500';
                    }
                });
            }

            function selectPetById() {
                if (selectedPetId) {
                    deselectAllPets();
                    selectPetButtons.forEach(button => {
                        const row = button.closest('tr');
                        if (row.cells[0].textContent.trim() === selectedPetId) {
                            const textSpan = button.querySelector('span');
                            textSpan.textContent = 'Selected';
                            textSpan.style.color = 'green';
                            textSpan.style.fontWeight = '600';
                        }
                    });
                }
            }

            selectPetButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    deselectAllPets();

                    const textSpan = event.currentTarget.querySelector('span');
                    textSpan.textContent = 'Selected';
                    textSpan.style.color = 'green';
                    textSpan.style.fontWeight = '600';
                    const row = event.currentTarget.closest('tr');
                    selectedPetId = row.cells[0].textContent.trim();
                    selectedPetName = row.querySelector('.pet-name').textContent.trim();
                    const selectedPetImage = row.querySelector('.avatar-img').getAttribute('src');
                    const selectedPetLink = row.querySelector('.btn-to-pet').getAttribute('href');

                    const selectedPetInfoDivs = document.querySelectorAll('.selected-pet-info');
                    selectedPetInfoDivs.forEach(div => {
                        div.querySelector('.selected-pet-image').setAttribute('src', selectedPetImage);
                        div.querySelector('.selected-pet-name').textContent = selectedPetName;
                        div.querySelector('.selected-pet-link').setAttribute('href', selectedPetLink);
                        div.style.display = 'flex'; 
                    });
                });
            });

            selectPetById();
        }
    
        setupSelectButtons();
     
        var productInputValues = {};

        let previews = {};

        $('table tr').each(function() {
            let row = $(this);
            let productId = row.find('.product-id').text().trim();
            productId = parseInt(productId);
        
            if (!productInputValues[productId]) {
                productInputValues[productId] = {};
            }
        
            row.find('input').each(function() {
                let inputElem = $(this);
                let inputClass = inputElem.attr('class').split(' ')[1];
                productInputValues[productId][inputClass] = inputElem.val();
            });
        });
        
        $('table').on('input', 'input', function() {
            let row = $(this).closest('tr');
            let productId = row.find('.product-id').text().trim();
            productId = parseInt(productId);
            
            let inputClass = $(this).attr('class').split(' ')[1]; 
            productInputValues[productId][inputClass] = $(this).val();
        });
        
        function refreshProductRows() {
            $('.add-product').each(function() {
                var row = $(this).closest('tr');
                var productId = row.find('.product-id').text().trim();
                productId = parseInt(productId);
                
                if (productInputValues[productId]) {
                    for (let inputClass in productInputValues[productId]) {
                        row.find('.' + inputClass).val(productInputValues[productId][inputClass]);
                    }
                } 
                console.log(productInputValues)
                if (selectedProductIds.has(productId)) {
                    $(this).prop('disabled', true);
                    row.find('.add-text').text("Added");
                } else {
                    $(this).prop('disabled', false);
                    row.find('.add-text').text("Add");
                }
            });
        }

        document.addEventListener('input', function (event) {
            
            if (!event.target.matches('.product-strength, .product-quantity, .product-dosage, .product-frequency, .product-remarks')) {
                return;
            }

            let row = event.target.closest('tr');
            if (row && row.querySelector('.product-id')) {
                let productID = row.querySelector('.product-id').textContent.trim();
                let productName = row.querySelector('.product-name').textContent.trim();
                let productType = row.querySelector('.product-type').textContent.trim();
                let productForm = row.querySelector('.product-form').textContent.trim().toLowerCase();
                let productQuantity = row.querySelector('.product-quantity').value.trim();
                let strength = row.querySelector('.product-strength').value || '[STRENGTH]';
                let dosage = row.querySelector('.product-dosage').value || '[DOSAGE]';
                let frequency = row.querySelector('.product-frequency').value || '[FREQUENCY]';
                let remarks = row.querySelector('.product-remarks').value || '[REMARKS]';
                
                remarks = remarks.charAt(0).toLowerCase() + remarks.slice(1);
                frequency = frequency.charAt(0).toLowerCase() + frequency.slice(1);
                let dosageUnit = getDosageUnit(productForm, dosage);
                let rowIndex = [...row.parentNode.children].indexOf(row);
                let previewText = `${productID} - Prescribed: <b>${productQuantity}</b> of <b>${productName}</b> (<b>${strength}</b> per ${dosageUnit}). Dosage: Administer <b>${dosage} ${dosageUnit}</b> to the pet <b>${frequency}</b>. For best results or safety, it's recommended to <b>${remarks}</b>.`;
        
                previews[productID] = previewText;

                let previewKeys = Object.keys(previews).sort();
                let previewTexts = previewKeys.map(key => previews[key]);
                document.getElementById('preview-text').innerHTML = previewTexts.join('<br>');
            }
        });

        {% for type, products in product_dict.items %}
        var dataTable_{{ forloop.counter }};
        {% endfor %}

        {% for type, products in product_dict.items %}
        const datatablesSimple_products_{{ forloop.counter }} = document.getElementById('table-medicines-{{ forloop.counter }}');

        if (datatablesSimple_products_{{ forloop.counter }}) {
            dataTable_{{ forloop.counter }} = new simpleDatatables.DataTable(datatablesSimple_products_{{ forloop.counter }}, {
                paging: true,
                perPageSelect: [5, 10, 25, {% if products_count > 50 %} {{ products_count }} {% else %} 50 {% endif %}],
                perPage: 5,
                sortable: true,
                searchable: true,
                hiddenHeader: false,
                // labels: {
                //     info: `Products Table`,
                // },
            });
        }

        dataTable_{{ forloop.counter }}.on('datatable.update', function() {
            refreshProductRows();
        });
        dataTable_{{ forloop.counter }}.on('datatable.page', function(page) {
            refreshProductRows();
        });
        dataTable_{{ forloop.counter }}.on('datatable.search', function(query, matched) {
            refreshProductRows();
        });
        dataTable_{{ forloop.counter }}.on('datatable.sort', refreshProductRows);

        var searchInput = document.querySelector(`[aria-controls="table-medicines-{{ forloop.counter }}"]`);
     
        if (searchInput) {
            searchInput.addEventListener('search', function(e) {
                if (e.target.value == '') {
                    dataTable_{{ forloop.counter }}.search('');
                    refreshProductRows();
                }
            });
        }
        {% endfor %}

        var isFirstRun = true;

        $('#addMedicineModal').on('show.bs.modal', function (event) 
        {

            refreshProductRows()
            {% for type, products in product_dict.items %}
 
                $(datatablesSimple_products_{{ forloop.counter }}).find('.add-product').each(function() {
                    //var productId = $(this).data('product-id');
                    var productId = $(this).closest('tr').find('.product-id').text().trim();
                    
                    var row = $(this).closest('tr');
                    if (selectedProductIds.has(productId)) {
                        row.find('.add-product').prop('disabled', true); 
                        row.find('.add-text').text("Added");
                    } 
                    if(isFirstRun)
                    {
                        $.ajax({
                            url: '/admin/inventory/check-expiry/' + productId + '/',
                            method: 'GET',
                            success: function(data) {
                                var stockExpiry = data.expiry;
                
                                if(stockExpiry != null) {
                                    var stockExpiryDate = new Date(stockExpiry);
                                    var today = new Date();
                
                                    if(stockExpiryDate < today) {
                                        row.find('.add-product').prop('disabled', true);
                                    }
                                }
                            }
                        });
            
                        $.ajax({
                            url: '/admin/inventory/check-quantity/' + productId + '/',
                            method: 'GET',
                            success: function(data) {
                                var stockQuantity = data.quantity;
            
                                if(stockQuantity != null) {
                                    if(parseFloat(stockQuantity) == 0) {
                                        row.find('.add-product').prop('disabled', true);
                                    }
                                }
                            }
                        });
                        isFirstRun = false;
                    }
    
                });
                //var searchInput = document.querySelector('.datatable-input');
    
                //searchInput.addEventListener('search', function(e) {
                //    if (e.target.value == '') {
                //        datatablesSimple_products_{{ forloop.counter }}.search('');
                //    }
                //});
            {% endfor %}
        
        });

        function getDosageUnit(form, dosage) {
            const liquidForms = ['syrup', 'liquid', 'oral_solution', 'suspension', 'ear_drop', 'gel', 'cream', 'ointment', 'lotion'];
            if (liquidForms.includes(form)) {
                return 'mL';
            } else {
                if (dosage === '1') {
                    return form;
                } else {
                    return form + 's';
                }
            }
        }
        let productRowIndexMap = new Map();

        {% for product_id, product_details in products_map.items %}
        productRowIndexMap.set({{ product_id }}, {{ forloop.counter0 }});
        {% endfor %}

        $(document).on('click', '.add-product', function() 
        { 
            $(this).attr('data-active-ajax', true);
            var $this = $(this);
    
            var productId = $(this).closest('tr').find('.product-id').text().trim();
            productId = parseInt(productId);
            
            if (selectedProductIds.has(productId)) {
                $this.prop('disabled', true);
                return;
            }
    
            var row = $(this).closest('tr');
            var productName = row.find('.product-name').text();
            var productStrength = row.find('.product-strength').val();
            //var productForm = row.find('.product-form option:selected').val();
           // var productFormText = row.find('.product-form option:selected').text();
            var quantityInput = row.find('.product-quantity');
            var quantity = quantityInput.val();
            var productDosage = row.find('.product-dosage').val();
            var productFrequency = row.find('.product-frequency').val();
            var productRemarks = row.find('.product-remarks').val();
    
            if(productStrength == null || productStrength == "") {
                showError("Please enter the strength of the medicine.");
                return;
            }
            // else if(productForm == null || productForm == "----") {
            //     showError("Please select form.");
            //     return;
            // }
            else if((quantity.split('.')[1] || []).length > 2)
            {
                showError("Only 2 decimal points for the quantity.");
                quantityInput.focus();
                return;
            }
            else if(productDosage == null || productDosage == "") {
                showError("Please enter the dosage of the medicine.");
                return;
            }
            else if(productFrequency == null || productFrequency == "") {
                showError("Please enter the frequency of the medicine.");
                return;
            }
            else if(parseFloat(quantity) <= 0)
            {
                showError("The entered quantity is invalid.");
                return;
            }


            var activeAjaxRequests = 0;
            
            $(document).ajaxStart(function() {
                activeAjaxRequests++;
                if (activeAjaxRequests === 1) { 
    
                    var $this = $('.add-product[data-active-ajax="true"]');
                    $this.prop('disabled', true);
                    $this.find('.add-text').text("Adding...");
                    $this.find('.add-product-ajax-loading').removeClass('d-none');
                }
            }).ajaxStop(function() {
                activeAjaxRequests--;
                if (activeAjaxRequests === 0) { 
                    var $this = $('.add-product[data-active-ajax="true"]');
                    // $this.prop('disabled', false);
                    // $this.find('.add-text').text("Add");
                    $this.find('.add-product-ajax-loading').addClass('d-none');
                    $this.removeAttr('data-active-ajax'); 
                }
            });
   
            $.ajax({
                    url: '/admin/inventory/check-quantity/' + productId + '/',
                    method: 'GET',
                    success: function(data) {
                        var stockQuantity = data.quantity;

                        if(stockQuantity != null) {
                            if(parseFloat(stockQuantity) == 0) {
                                showError("The product is out of stock.");
                                $this.prop('disabled', false);
                                $this.find('.add-text').text("Add");
                                return;
                            }
                            else if(parseFloat(quantity) > stockQuantity) {
                                showError(`You only have ${stockQuantity} of this product in stock.`);
                                quantityInput.focus();
                                $this.prop('disabled', false);
                                $this.find('.add-text').text("Add");
                                return;
                            }
                        }

                        selectedProductIds.add(productId);

                        var productDetails = {
                            strength: productStrength,
                            //form: productForm,
                            quantity: quantity,
                            dosage: productDosage,
                            frequency: productFrequency,
                            remarks: productRemarks,
                        };

                        productsSelected.set(productId, productDetails);
                        
                        let rowObj = {
                            "#": productId, 
                            "Product": productName,
                            "Strength": productStrength,
                            //"Form": productForm,
                            "Quantity": quantity,
                            "Dosage": productDosage,
                            "Frequency": productFrequency,
                            "Remarks": productRemarks
                        };
                        prescriptionSummaryDataTable.insert([rowObj]);

                        let rowIndex = prescriptionSummaryDataTable.rows.dt.data.data.length - 1;
                        
                        productRowIndexMap.set(productId, rowIndex);

                        console.log(productRowIndexMap)

                        $this.prop('disabled', true);
                        $this.find('.add-text').text("Added");
                        
                        quantity = parseFloat(quantity);
                        
                        var newRow = `
                            <tr class="selected-product" data-product-id="${productId}" data-product-quantity="${quantity}">
                                <td>
                                    <div class="fw-bold">
                                        ${productName} (<span class="product-quantity">${quantity.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>)
                                        <a class="btn btn-datatable btn-icon btn-transparent-dark remove-product" href="#" data-bs-toggle="tooltip" data-bs-placement="top" title="Remove">
                                            <span class="product-id-remove-button" style="display: none;">${productId}</span>
                                            <i data-feather="delete"></i>
                                        </a>
                                    </div>
                                </td>
                                <td class="text-end fw-bold">${productStrength}</td>
                                <td class="text-end fw-bold">${productDosage}</td>
                                <td class="text-end fw-bold">${productFrequency}</td>
                                <td class="text-end fw-bold">${productRemarks}</td>
                            </tr>
                        `;
                        
                        $('#total-row').before(newRow);
                        // $('#addProductModal').modal('hide');
                        feather.replace();
                    }
            });
    
        }); 
        
        $(document).on('click', '.remove-product', function(e) 
        {
            e.preventDefault();
    
            var productId = $(this).find('.product-id-remove-button').text();
            productId = parseInt(productId);

            selectedProductIds.delete(productId);
            productsSelected.delete(productId);
    
            let rowIndex = productRowIndexMap.get(productId);

            prescriptionSummaryDataTable.rows.remove(rowIndex);

            productRowIndexMap.delete(productId);

            productRowIndexMap.forEach((index, id) => {
                if (index > rowIndex) {
                    productRowIndexMap.set(id, index - 1);
                }
            });

            $('.add-product[data-product-id="' + productId + '"]').prop('disabled', false);
            var addProductButton = $('.add-product[data-product-id="' + productId + '"]');
            addProductButton.html('<span class="spinner-border spinner-border-sm add-product-ajax-loading d-none" role="status" aria-hidden="true"></span><span class="add-text">Add</span>');
            addProductButton.prop('disabled', false);
    
            $(this).closest('tr').remove();
        });

        let inds = {{ laboratory_results|length }} + 1;

        document.getElementById('addLabResultBtn').addEventListener('click', function(e) {
            e.preventDefault();

            const initialLabResultGroup = document.querySelector('.lab-result-group-fields');

            const newLabResultGroup = initialLabResultGroup.cloneNode(true);
            newLabResultGroup.style.marginTop = '1rem';

            updateIds(newLabResultGroup);

            resetInputValues(newLabResultGroup);

            const addButton = newLabResultGroup.querySelector('.btn-add-lab-result');
            addButton.remove();

            const removeButton = createRemoveButton();
            newLabResultGroup.querySelector('.second-row-lab-r').appendChild(removeButton);

            initialLabResultGroup.parentNode.insertBefore(newLabResultGroup, initialLabResultGroup.nextSibling);

            feather.replace();
        });

        function createRemoveButton() {
            const button = document.createElement('button');
            button.className = 'btn btn-remove-lab-result';
            button.type = 'button';
            
            const icon = document.createElement('i');
            icon.setAttribute('data-feather', 'minus-circle');
            button.appendChild(icon);
            
            button.addEventListener('click', function(e) {
                e.preventDefault();
                this.closest('.lab-result-group-fields').remove();
            });
            
            return button;
        }

        function updateIds(element) {
            const labResultInputs = element.querySelectorAll('[data-id]');
            const dataExistingLabID = element.querySelectorAll('[data-existing-lab-id]');
            const btnImages = element.querySelectorAll('.btn-view-lab-result-image');

            btnImages.forEach(btn => {
                const newButton = document.createElement('button');
                
                newButton.className = btn.className.replace('btn-view-lab-result-image', 'btn-no-image');
                
                newButton.type = 'button';
                newButton.disabled = true;
                newButton.setAttribute('data-bs-toggle', 'tooltip');
                newButton.setAttribute('data-bs-placement', 'left');
                newButton.title = 'This laboratory result has no image';
                
                const icon = document.createElement('i');
                icon.setAttribute('data-feather', 'x-square');
                
                newButton.appendChild(icon);
                
                btn.parentNode.replaceChild(newButton, btn);
            });
            labResultInputs.forEach(input => {
                input.dataset.id = inds;
                // if (input.id) {
                //     input.id += inds;
                // }
            });
            dataExistingLabID.forEach(input => {
                input.dataset.existingLabId = null;
            });
            inds++;
        }

        function resetInputValues(element) {
            const inputs = element.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.type !== 'button' && input.type !== 'file') {
                    input.value = '';
                }
            });

            const fileInput = element.querySelector('.lab-result-image-input');
            if (fileInput) {
                fileInput.value = null;
            }

            const progressBar = element.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = '0%';
                progressBar.setAttribute('aria-valuenow', '0');
                progressBar.textContent = '0%';
            }

            const testUnit = element.querySelector('.lab-test-unit');
            if (testUnit) {
                testUnit.textContent = '';
            }

            const labRSelect = element.querySelector('.lab-result-select');
            if (labRSelect) {
                labRSelect.selectedIndex = 0;
            }
        }

        $(document).on('input', '#inputCustomPurpose', function(e) {
            $('#nextAppointmentPurpose').val("");
        });
        
        $(document).on('change', '#nextAppointmentPurpose', function(e) {
            $('#inputCustomPurpose').val("");
        });

        $(document).on('click', '.submit-button', function(e)
        {
            $('#confirmationModal').modal('show');
        });

        $(document).on('click', '#confirm-consultation-button', function(e)
        {
            $('#confirmationModal').modal('hide');
            if(selectedPetId == null)
            {
                activateTab(0);
                showError("Please select a pet.");
                return;
            }

            var symptoms = $('#inputSymptoms').val();
            var temperature = $('#inputTemperature').val();
            var weight = $('#inputTreatmentWeight').val();
            var diagnosis = $('#inputDiagnosis').val();
            var treatment = $('#inputTreatment').val();

            var isDeworming = $('#dewormingRadio').is(':checked');
            var isVaccination = $('#vaccRadio').is(':checked');

            var labResults = $('#inputLabResults').val();

            var appointment_date = $('#litepickerSingleDate').val();
            var appointment_time = $('#inputNextAppointmentTime').val();
            var appointment_purpose = $('#nextAppointmentPurpose').val();

            if(symptoms == null || symptoms == "")
            {
                activateTab(0);
                showError("Please enter the symptoms.");
                return;
            }
            else if(temperature == null || temperature == "")
            {
                activateTab(0);
                showError("Please enter the temperature.");
                return;
            }
            else if(weight == null || weight == "")
            {
                activateTab(0);
                showError("Please enter the weight.");
                return;
            }
            else if(diagnosis == null || diagnosis == "")
            {
                activateTab(0);
                showError("Please enter the diagnosis.");
                return;
            }
            else if(treatment == null || treatment == "")
            {
                activateTab(0);
                showError("Please enter the treatment.");
                return;
            }
            else if(appointment_date != null && appointment_date != "" )
            {
                if(appointment_time == null || appointment_time == "")
                {
                    activateTab(2);
                    showError("Please enter the appointment time.");
                    return;
                }
            }

            var noLabResultInputFound = false;

            $('.lab-result-input').each(function() {
                var labResult = $(this).val();
                if(labResult == null || labResult.trim() === "") {
                    noLabResultInputFound = true;
                }
            });

            if(noLabResultInputFound) {
                activateTab(0);
                showError("Please enter the lab results.");
                return;
            }

            var custom_purpose = $('#inputCustomPurpose').val();
            
            const labResultInputs = document.querySelectorAll('.lab-result-input');
            const labResult2Inputs = document.querySelectorAll('.lab-result-second-input');
            const labTestUnits = document.querySelectorAll('.lab-test-unit-to-submit');
            const labResultNormalRangeInputs = document.querySelectorAll('.lab-result-normal-range-input');
            const labResultImageInputs = document.querySelectorAll('.lab-result-image-input');
            const labResultIds = document.querySelectorAll('.laboratory-result-id');

            var formData = new FormData();

            formData.append('treatmentId', {{ treatmentID }});
            formData.append('productsSelected', JSON.stringify([...productsSelected]));
            formData.append('selectedPetId', selectedPetId);
            formData.append('appointment_date', appointment_date);
            formData.append('appointment_time', appointment_time);
            formData.append('appointment_purpose', appointment_purpose);
            formData.append('symptoms', symptoms);
            formData.append('temperature', temperature);
            formData.append('weight', weight);
            formData.append('diagnosis', diagnosis);
            formData.append('treatment', treatment);

            {% comment %} var labResultsDescriptions = [];
            var labResultsImageIDS = [];

            labResultInputs.forEach((input) => {
                labResultsDescriptions.push(input.value);
                let matchingImageData = labResultsData.find(item => item.id == input.dataset.id);
                if (matchingImageData) {
                    labResultsImageIDS.push(matchingImageData.image_id);
                }
                else{
                    labResultsImageIDS.push(null);
                }
            }); {% endcomment %}

            let labResultsForm = [];


            function getLabResultId(dataId) {
                let inputElement = document.querySelector(`.lab-result-input[data-id="${dataId}"]`);
                if (inputElement) {
                    return inputElement.getAttribute("data-existing-lab-id");
                }
                return null;
            }
            
            var _index = 0;

            labResultInputs.forEach((input) => {
                let id = input.dataset.id;
            
                let description = input.value;
            
                let labResultId = getLabResultId(id);
            
                let labResult2Input = labResult2Inputs[_index];
                let labTestUnit = labTestUnits[_index];
                let labResultNormalRangeInput = labResultNormalRangeInputs[_index];

                let matchingImageData = labResultsData.find(item => item.id == id);
                let imageId = matchingImageData ? matchingImageData.image_id : null;
                labResultsForm.push({
                    description: description,
                    result: labResult2Input.value + ' ' + labTestUnit.textContent || null,
                    normal_range: labResultNormalRangeInput.value + ' ' + labTestUnit.textContent  || null,
                    image_id: imageId,
                    lab_result_id: labResultId  
                });

                _index++;
            });
            
            formData.append('labResults', JSON.stringify(labResultsForm));

            {% comment %} formData.append('labResultsDescriptions', JSON.stringify(labResultsDescriptions));
            formData.append('labResultsImageIDS', JSON.stringify(labResultsImageIDS)); {% endcomment %}
            formData.append('isDeworming', isDeworming);
            formData.append('isVaccination', isVaccination);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            $.ajax({
                url: "{% url 'admin-submit-update-consultation-page' %}",
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if(response.success)
                    {
                        var petLink = document.querySelector('.pet-link a');
                        var originalHref = petLink.getAttribute('href');
                        var newHref = originalHref.replace('0', selectedPetId);

                        petLink.setAttribute('href', newHref);

                        showSuccess(response.message);

                        var ownerID = response.pet_owner_id;

                        $(document).on('click', '.successOKBtn', function(e)
                        {
                            location.reload();
                        });
                    }
                    else
                    {
                        showError(response.message);
                        $(document).on('click', '.errorOKBtn', function(e)
                        {
                            if(response.appointment_error)
                            {
                                activateTab(0);
                            }
                            
                        });
                    }

                },
                error: function(response)
                {
                    if(response.status == 429)
                    {
                        showError(`${response.responseJSON.message} Please wait for ${response.responseJSON.wait} second(s) before submitting again.`);
                    } 
                }
            });
        });

        function populateTable(tableElement) {
            if (!tableElement) return;
            const tableBody = tableElement.querySelector('tbody');
            let index = 1;
        
            tableBody.innerHTML = '';
            
            productsSelected.forEach((value, key) => {
                let row = tableBody.insertRow();
                
                let cell1 = row.insertCell(0);
                cell1.innerHTML = index++;

                let cell2 = row.insertCell(1);
                cell2.innerHTML = key;
                
                let cell3 = row.insertCell(2);
                cell3.innerHTML = value.strength;

                let cell4 = row.insertCell(3);
                cell4.innerHTML = value.form;

                let cell5 = row.insertCell(4);
                cell5.innerHTML = value.quantity;    
                
                let cell6 = row.insertCell(5);
                cell6.innerHTML = value.dosage; 

                let cell7 = row.insertCell(6);
                cell7.innerHTML = value.frequency; 

                let cell8 = row.insertCell(7);
                cell8.innerHTML = value.remarks; 
            });
        }
        
        const prescriptionSummary = document.getElementById('table-medicines-summary');
        let prescriptionSummaryDataTable;

        if (prescriptionSummary) {
            
            prescriptionSummaryDataTable = new simpleDatatables.DataTable(prescriptionSummary, {
                paging: false,
                perPageSelect: [5, 10, 25, 50],
                perPage: 10,
                fixedHeight: false,
                sortable: false,
                searchable: false,
                hiddenHeader: false,
            });

        }    

        function getTableDataFromSelectedProducts() {
            let dataArray = [];
            let index = 1;
            
            productsSelected.forEach((value, key) => {
                let rowObj = {
                    "#": index++, 
                    "Product": key,
                    "Strength": value.strength,
                    "Form": value.form,
                    "Quantity": value.quantity,
                    "Dosage": value.dosage,
                    "Frequency": value.frequency,
                    "Remarks": value.remarks
                };

                dataArray.push(rowObj);
            });
            return dataArray;
        }

        function updateLabResultsPreview() {
            $('.lab-results-container').empty();

            $('.lab-result-input').each(function(index, input) {
                var resultText = $(input).val();
                var imageInput = $(`.lab-result-image-input[data-id="${$(input).data('id')}"]`);
                var imageUrl = imageInput.val() ? URL.createObjectURL(imageInput[0].files[0]) : null;

                var label = index === 0 ? "Laboratory Results:" : "";

                var imageLink = imageUrl ? `
                    <a href="${imageUrl}" class="btn btn-datatable btn-icon btn-transparent-dark" target="_blank" data-bs-toggle="tooltip" data-bs-placement="top" title="View Image">
                        <i data-feather="image"></i>
                    </a>
                ` : '';

                var newRow = `
                    <div class="row small text-muted">
                        <div class="col-sm-3 text-truncate"><em>${label}</em></div>
                        <div class="col lab-results">
                            ${resultText}
                            ${imageLink}
                        </div>
                    </div>
                `;

                $('.lab-results-container').append(newRow);
            });

            feather.replace();
        }


        $(document).on('input', '.lab-result-input, .lab-result-image-input', updateLabResultsPreview);

        updateLabResultsPreview();
        
        $('#wizard1-tab').on('click', function(e) {
            e.preventDefault();
            activateTab(0);
            updateButtonState(0);
        });

        $('#wizard2-tab').on('click', function(e) {
            e.preventDefault();
            activateTab(1);
            updateButtonState(1);
        });

        $('#wizard3-tab').on('click', function(e) {
            e.preventDefault();
            activateTab(2);
            updateButtonState(2);
        });

        document.getElementById('wizard1-tab').addEventListener('shown.bs.tab', function (event) {
            localStorage.setItem('activeTab', 'wizard1');
        });
        document.getElementById('wizard2-tab').addEventListener('shown.bs.tab', function (event) {
            localStorage.setItem('activeTab', 'wizard2');
        });
        document.getElementById('wizard3-tab').addEventListener('shown.bs.tab', function (event) {
            localStorage.setItem('activeTab', 'wizard3');
            $('.selected-pet-name').text(selectedPetName || "None");
            $('.lab-symptoms').text($('#inputSymptoms').val() || "None");
            $('.treatment-weight').text($('#inputTreatmentWeight').val() || "None");
            $('.temperature').text($('#inputTemperature').val() || "None");
            $('.diagnosis').text($('#inputDiagnosis').val() || "None");
            $('.treatment').text($('#inputTreatment').val() || "None");

            let appointmentDate = $('#litepickerSingleDate').val();
            let appointmentTimeText = $('#inputNextAppointmentTime option:selected').text();
            $('.next-appointment').text((appointmentDate && appointmentTimeText) ? (appointmentDate + ' - ' + appointmentTimeText) : "None");   
            let rows = prescriptionSummaryDataTable.rows;
        });

        const removeButtons = document.querySelectorAll('.btn-remove-lab-result');

        removeButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();

                const parentInputGroup = e.target.closest('.lab-result-group-fields');
                
                if(parentInputGroup) {
                    // parentInputGroup.nextElementSibling.remove(); 
                    parentInputGroup.remove();
                }
            });
        });

        const temperatureInput = document.getElementById('inputTemperature');
        const weightInput = document.getElementById('inputTreatmentWeight');

        function preventInvalidInput(event) {
            const invalidKeyCodes = [69, 101, 189, 187]; 
            
            if (invalidKeyCodes.includes(event.keyCode)) {
                event.preventDefault();
            }
        }

        function enforceTwoDecimalPlaces(event) {
            const value = event.target.value;
            if (value.includes('.')) {
                const decimalPortion = value.split('.')[1];
                if (decimalPortion.length > 2) {
                    event.target.value = parseFloat(value).toFixed(2);
                }
            }
        }

        function enforceMaxDigits(event) {
            const value = event.target.value;
            if (value.length > 6) {
                event.target.value = value.slice(0, 6);  
            }
        }

        function preventPaste(event) {
            event.preventDefault();
        }

        [temperatureInput, weightInput].forEach(input => {
            input.addEventListener('keydown', preventInvalidInput);
            input.addEventListener('paste', preventPaste);
            input.addEventListener('input', enforceTwoDecimalPlaces);
            input.addEventListener('input', enforceMaxDigits);
        });
    });
</script>
<script>
    $(document).ready(function() {
        const regex = /[^a-zA-Z\s\-:'"]/g;
        const leadingSpaceRegex = /^\s+/;
        const numberAndCharacterRegex = /[^0-9a-zA-Z\s\.\-]/g;

        $("#inputSymptoms, #inputDiagnosis, #inputLabResults, #inputTreatment").on("input", function() {
            let value = $(this).val();
            value = value.replace(regex, "");
            value = value.replace(leadingSpaceRegex, "");
            if (value.length > 0) {
                value = value.charAt(0).toUpperCase() + value.slice(1);
            }
            $(this).val(value);
        });

        $(document).on("input", ".lab-result-second-input", function() {
            let value = $(this).val();
            let decimalNumberRegex = /^\d*(\.\d{0,2})?$/;

            if (!decimalNumberRegex.test(value)) {
                $(this).val($(this).data('lastValid') || '');
            } else {
                $(this).data('lastValid', value);
            }
        });

        $(document).on("input", ".lab-result-normal-range-input", function() {
            let value = $(this).val();
            let formatRegex = /^(\d+(\.\d{0,2})?)?\s?(-\s?(\d+(\.\d{0,2})?)?)?$/;

            if (!formatRegex.test(value)) {
                $(this).val($(this).data('lastValid') || '');
            } else {
                $(this).data('lastValid', value);
            }
        });
    });
</script>