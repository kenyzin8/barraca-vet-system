<script>
    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
    function showError(message) {
        $('#errorModal .modal-body').text(message);
        $('#errorModal').modal('show');
    }
    
    function formatDates(date) {
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const day = String(date.getDate()).padStart(2, '0');
        const monthIndex = date.getMonth();
        const year = date.getFullYear();
    
        return monthNames[monthIndex] + ' ' + day + ', ' + year;
    }
    
    function formatStringDate(dateString) {
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    
        const parts = dateString.split('-');
        const year = parts[0];
        const month = parts[1] - 1;
        const day = parts[2];
    
        const date = new Date(year, month, day);
    
        return monthNames[date.getMonth()] + ' ' + String(date.getDate()).padStart(2, '0') + ', ' + year;
    }
    
    function getEventCounts(events) {
        const eventCounts = {};
    
        events.forEach(event => {
            const date = FullCalendar.formatDate(event.start, {
                timeZone: 'local',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            eventCounts[date] = (eventCounts[date] || 0) + 1;
        });
    
        return eventCounts;
    }
    
    function toLocalDate(date) {
        var localOffset = date.getTimezoneOffset() * 60000;
        var localTime = date.getTime();
        var utcTime = localTime - localOffset;
        var targetDate = new Date(utcTime);
        var dd = String(targetDate.getDate()).padStart(2, '0');
        var mm = String(targetDate.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = targetDate.getFullYear();
        return yyyy + '-' + mm + '-' + dd;
    }
    
    function getInitialView() {
        return window.innerWidth <= 576 ? 'listYear' : 'dayGridMonth';
    }
    function getDayOfYear(date) {
        var start = new Date(date.getFullYear(), 0, 0);
        var diff = date - start;
        var oneDay = 1000 * 60 * 60 * 24;
        var day = Math.floor(diff / oneDay);
        return day;
    }
    function showAppointmentDetails(appointmentId) {
        let appointment = document.getElementById(appointmentId);
    
        let client = appointment.getAttribute('data-client-name');
        let pet = appointment.getAttribute('data-pet-rname');
        let purpose = appointment.getAttribute('data-purpose-val');
        let timeOfDay = appointment.getAttribute('data-time-of-day')
    
        
        timeOfDay = timeOfDay.charAt(0).toUpperCase() + timeOfDay.slice(1);
    
        const details = [
            `<strong>Client:</strong> ${client}`,
            `<strong>Pet:</strong> ${pet}`,
            `<strong>Time of the Day:</strong> ${timeOfDay}`,
            `<strong>Purpose:</strong> ${purpose}`
        ].join('<br>');
    
        document.getElementById('rebookListAppointmentLabel').innerText = "#" + appointmentId + " from Rebook List";
        document.getElementById('rebookListAppointmentBody').innerHTML = details;
    
        document.getElementById('doneRebookList').onclick = function() {
            $('#rebookListAppointmentModal').modal('hide');
            $('#doneAppointmentModal').modal('show');
        };
    
        document.getElementById('yesDoneAppointmentButton').onclick = function() {
            $('#doneAppointmentModal').modal('hide');

            $.ajax({
                type: 'POST',
                url: '{% url "mark_as_done" %}',
                data: {
                    'appointment_id': appointmentId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'Appointment marked as done successfully') {
                        appointment.remove();
                        location.reload();
                    }
                },
                error: function(error) {
                    showError(error.responseJSON.message);
                }
            });
        };
    
        var cancelDoneAppointmentButton = document.getElementsByClassName('cancelDoneAppointmentButton');
        for (var i = 0; i < cancelDoneAppointmentButton.length; i++) {
            cancelDoneAppointmentButton[i].onclick = function() {
                $('#doneAppointmentModal').modal('hide');
                $('#rebookListAppointmentModal').modal('show');
            };
        }
    
        document.getElementById('deleteRebookList').onclick = function() {
            $('#rebookListAppointmentModal').modal('hide');
            $('#deleteAppointmentModal').modal('show');
        };
    
        document.getElementById('yesDeleteAppointmentButton').onclick = function() {
            $.ajax({
                type: 'POST',
                url: '{% url "cancel_appointment" %}',
                data: {
                    'appointment_id': appointmentId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'Appointment cancelled successfully') {
                        appointment.remove();
                        $('#deleteAppointmentModal').modal('hide');
                        location.reload();
                    }
                },
                error: function(error) {
                    $('#deleteAppointmentModal').modal('hide');
                    showError(error.responseJSON.message);
                }
            });
        };
    
        var cancelDeleteAppointmentButton = document.getElementsByClassName('cancelDeleteAppointmentButton');
        for (var i = 0; i < cancelDeleteAppointmentButton.length; i++) {
            cancelDeleteAppointmentButton[i].onclick = function() {
                $('#deleteAppointmentModal').modal('hide');
                $('#rebookListAppointmentModal').modal('show');
            };
        }
    
    
        $('#rebookListAppointmentModal').modal('show');
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        var appointmentIdToMarkDone;
    
        const datatablesSimple = document.getElementById('datatablesSimple');
        var dataTable = null;
        if (datatablesSimple) {
            dataTable = new simpleDatatables.DataTable(datatablesSimple, {
                paging: true,
                perPageSelect: [5, 10, 25, 50],
                perPage: 10,
                fixedHeight: true,
                sortable: true,
                searchable: true,
                hiddenHeader: false,
            });
    
            dataTable.on('datatable.update', () => {
                feather.replace();
    
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                })
            });
    
            dataTable.on('datatable.page', function(page) {
                feather.replace();
    
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                })
            });
    
            dataTable.on('datatable.search', function(query, matched) {
                feather.replace();
    
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                })
            });
    
            dataTable.on('datatable.sort', function(column, direction) {
                feather.replace();
    
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                })
            });
    
            var searchInput = document.querySelector('.datatable-input');
    
            searchInput.addEventListener('search', function(e) {
                if (e.target.value == '') {
                    dataTable.search('');
                }
            });
        }
    
        $.ajax({
            type: 'GET',
            url: '{% url "get_appointments" %}',
            dataType: 'json',
            success: function(response)
            {
                var allAppointments = response;
                $.ajax({
                    type: 'GET',
                    url: '{% url "get_disabled_days" %}',
                    dataType: 'json',
                    success: function(response) {
                        var disabledDays = response;
            
                        $.ajax({
                            type: 'GET',
                            url: '{% url "get_max_appointments" %}',
                            dataType: 'json',
                            success: function(response)
                            {
                                var maxAppointments = response;
                                maxAppointments = maxAppointments.max_appointments;
            
                                $.ajax({
                                    type: 'GET',
                                    url: '{% url "get_date_slots" %}',
                                    dataType: 'json',
                                    success: function(response)
                                    {
                                        var dateSlots = {};
                                        for (var i=0; i<response.length; i++) {
                                            // var date = new Date(response[i].date).toDateString();
                                            dateSlots[response[i].date] = response[i].slots;
                                        }
                                        
                                        var calendarEl = document.getElementById('calendar');
                                        var containerEl = document.getElementById('external-events-list');
                                        new FullCalendar.Draggable(containerEl, {
                                            itemSelector: '.fc-event',
                                            droppable: true,
                                            // eventDragStart: function(info) {
                                            //     alert(info)
                                            // },
                                            eventData: function(eventEl) {
                                                return {
                                                    title: eventEl.innerText.trim()
                                                }
                                            }
                                        });
            
                                        var calendar = new FullCalendar.Calendar(calendarEl, {
                                            themeSystem: 'bootstrap5',
                                            eventOrder: 'none',
                                            lazyFetching: true,
                                            progressiveEventRendering: true,
                                            views: {
                                                listDay: {
                                                    buttonText: 'Day'
                                                },
                                                dayGridMonth: {
                                                    buttonText: 'Month'
                                                },
                                                multiMonthYear: {
                                                    buttonText: 'Year'
                                                },
                                                listYear: {
                                                    buttonText: 'All'
                                                },
                                                listMonth: {
                                                    buttonText: 'Month'
                                                }
                                            },
                                            buttonText: {
                                                today: 'Today',
                                            },
                                            allDayText: '',
                                            firstDay: 1,
                                            noEventsText: 'No appointments to show',
                                            initialDate: getCurrentDateString(),
                                            initialView: getInitialView(),
                                            navLinks: true, // can click day/week names to navigate views
                                            selectable: true,
                                            selectMirror: true,
                                            editable: true,
                                            droppable: true,
                                            dayMaxEvents: false, // allow "more" link when too many events
                                            hiddenDays: [0],
                                            eventClick: function(arg) {
            
                                                var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
                                                const dateString = arg.event.start;
                                                const date = new Date(dateString);
                                                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                                                const day = monthNames[date.getMonth()] + " " + date.getDate() + ", " + date.getFullYear();
            
                                                var isDaySentIcon = arg.event.extendedProps.day_sms_reminder == false ? '<i data-feather="x-circle" style="margin-top: 4px;" data-bs-toggle="tooltip" data-bs-placement="right" title="Pending SMS"></i>' : '<i data-feather="check-circle" style="margin-top: 4px;" data-bs-toggle="tooltip" data-bs-placement="right" title="SMS Sent"></i>';
                                                var isWeekSentIcon = arg.event.extendedProps.week_sms_reminder == false ? '<i data-feather="x-circle" style="margin-top: 4px;" data-bs-toggle="tooltip" data-bs-placement="right" title="Pending SMS"></i>' : '<i data-feather="check-circle" style="margin-top: 4px;" data-bs-toggle="tooltip" data-bs-placement="right" title="SMS Sent"></i>';
            
                                                const details = [
                                                    `<strong>Client:</strong> ${arg.event.extendedProps.client}`,
                                                    `<strong>Pet:</strong> ${arg.event.extendedProps.pet}`,
                                                    `<strong>Time of the Day:</strong> ${arg.event.extendedProps.timeOfTheDay}`,
                                                    `<strong>Purpose:</strong> ${arg.event.extendedProps.purpose}`,
                                                    `<strong>Day Before SMS Status: </strong> <span>${isDaySentIcon}<span>`,
                                                    `<strong>Week Before SMS Status: </strong> <span>${isWeekSentIcon}<span>`,
                                                ].join('<br>');
            
                                                document.getElementById('eventModalLabel').innerText = "#" + arg.event.id + " - " + day;
                                                document.getElementById('eventModalBody').innerHTML = details;
                                                feather.replace();
                                                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                                                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                                                    return new bootstrap.Tooltip(tooltipTriggerEl)
                                                })
                                                eventModal.show();
            
                                                var popover = document.querySelector('.fc-popover');
                                                if (popover) {
                                                    popover.style.display = 'none';
                                                }
            
                                                var deleteAppointmentModal = new bootstrap.Modal(document.getElementById('deleteAppointmentModal'));
            
                                                document.getElementById('deleteEvent').onclick = function() {
                                                    eventModal.hide();
                                                    deleteAppointmentModal.show();
                                                };
            
                                                document.getElementById('yesDeleteAppointmentButton').onclick = function() {
                                                    $.ajax({
                                                        type: 'POST',
                                                        url: '{% url "cancel_appointment" %}',
                                                        data: {
                                                            'appointment_id': arg.event.id,
                                                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                                                        },
                                                        success: function(response) {
                                                            if (response.status === 'Appointment cancelled successfully') {
                                                                arg.event.remove();
                                                                eventModal.hide();
                                                                deleteAppointmentModal.hide();
                                                                var currentView = calendar.view;
                                                                localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                                                                location.reload();
                                                            }
                                                        },
                                                        error: function(error) {
                                                            deleteAppointmentModal.hide();
                                                            showError(error.responseJSON.message);
                                                        }
                                                    });
                                                };
            
                                                var cancelDeleteAppointmentButton = document.getElementsByClassName('cancelDeleteAppointmentButton');
                                                for (var i = 0; i < cancelDeleteAppointmentButton.length; i++) {
                                                    cancelDeleteAppointmentButton[i].onclick = function() {
                                                        deleteAppointmentModal.hide();
                                                        eventModal.show();
                                                    };
                                                }
            
                                                document.getElementById('rebookEvent').onclick = function() {
                                                    eventModal.hide();
                                                    $('#rebookConfModal').modal('show');
                                                };
            
                                                document.getElementById('yesRebookConfButton').onclick = function() {
                                                    $.ajax({
                                                        type: 'POST',
                                                        url: '{% url "add_to_rebook_list" %}',
                                                        data: {
                                                            'appointment_id': arg.event.id,
                                                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                                                        },
                                                        success: function(response) {
                                                            if (response.status === 'Appointment rebooked successfully') {
                                                                arg.event.remove();
                                                                eventModal.hide();
            
                                                                var currentView = calendar.view;
                                                                localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                                                                location.reload();
                                                            }
                                                        },
                                                        error: function(error) {
                                                            $('#rebookConfModal').modal('hide');
                                                            showError(error.responseJSON.message);
                                                        }
                                                    });
                                                }
            
                                                var cancelRebookConfButtons = document.getElementsByClassName('cancelRebookConfButton');
                                                for (var i = 0; i < cancelRebookConfButtons.length; i++) {
                                                    cancelRebookConfButtons[i].onclick = function() {
                                                        $('#rebookConfModal').modal('hide');
                                                        eventModal.show();
                                                    };
                                                }
            
                                                document.getElementById('doneEvent').onclick = function() {
                                                    appointmentIdToMarkDone = arg.event.id;
                                                    eventModal.hide();
                                                    $('#doneAppointmentModal').modal('show');
                                                };
            
                                                document.getElementById('yesDoneAppointmentButton').onclick = function() {
                                                    $.ajax({
                                                        type: 'POST',
                                                        url: '{% url "mark_as_done" %}',
                                                        data: {
                                                            'appointment_id': appointmentIdToMarkDone,
                                                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                                                        },
                                                        success: function(response) {
                                                            if (response.status === 'Appointment marked as done successfully') {
                                                                arg.event.remove();
                                                                eventModal.hide();
                                                                var currentView = calendar.view;
                                                                localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                                                                location.reload();
                                                            }
                                                        },
                                                        error: function(error) {
                                                            $('#doneAppointmentModal').modal('hide');
                                                            showError(error.responseJSON.message);
                                                        }
                                                    });
                                                };
            
                                                var cancelDoneAppointmentButton = document.getElementsByClassName('cancelDoneAppointmentButton');
                                                for (var i = 0; i < cancelDoneAppointmentButton.length; i++) {
                                                    cancelDoneAppointmentButton[i].onclick = function() {
                                                        $('#doneAppointmentModal').modal('hide');
                                                        eventModal.show();
                                                    };
                                                }
                                            },
                                            events: allAppointments,
                                            select: function(arg) {
                                                let date = arg.start;
                                                window.selectedDate = date;
                                                let dateString = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            
                                                $('.day-clicked').text(formatStringDate(dateString));

                                                let appointmentsForDate = allAppointments.filter(function(appointment) {
                                                    var _date = new Date(appointment.start);
                                                    var _formattedDate = _date.getFullYear() + '-' + (_date.getMonth() + 1).toString().padStart(2, '0') + '-' + _date.getDate().toString().padStart(2, '0');
                                                    return _formattedDate === dateString;
                                                }).length;

                                                let availableSlots = dateSlots[dateString] == undefined ?
                                                    (maxAppointments - appointmentsForDate) :
                                                    (dateSlots[dateString] - appointmentsForDate);

                                                $('.available-slots').text(availableSlots + " / " + dateSlots[dateString] || maxAppointments);
                                                
                                                if (availableSlots <= 0) {
                                                    $('#add-appointment-day-choice').prop('disabled', true);
                                                    $('#disable-day-choice').prop('disabled', true);
                                                } else {
                                                    $('#add-appointment-day-choice').prop('disabled', false);
                                                    $('#disable-day-choice').prop('disabled', false);
                                                }
                                                
                                                // $('.slots').text(dateSlots[dateString] == undefined ? maxAppointments : dateSlots[dateString]);

                                                let disabledDay = disabledDays.find(function(day) {
                                                    return day.date === dateString;
                                                });
                                                
                                                if (disabledDay) {
                                                    $('#selectedDateToEnable').val(dateString);
                                                    if (disabledDay.timeOfTheDay === 'whole_day') {
                                                        $('#enableDayModal').modal('show');
                                                    } else {
                                                        if (disabledDay.timeOfTheDay === 'morning') {
                                                            $('.availability').text("Afternoon");
                                                            $('#id_timeOfTheDay option[value="morning"]').hide();
                                                            $('#id_timeOfTheDay').val('afternoon');
                                                        } else if (disabledDay.timeOfTheDay === 'afternoon') {
                                                            $('.availability').text("Morning");
                                                            $('#id_timeOfTheDay option[value="afternoon"]').hide();
                                                            $('#id_timeOfTheDay').val('morning');
                                                        }
                                                        $('#enable-day-choice').removeAttr('hidden');
                                                        $('#disable-day-choice').attr('hidden', true);
                                                        $('#dayChoiceModal').modal('show');
                                                    }
                                                } else {
                                                    $('.availability').text("Whole Day");
                                                    $('.day-clicked').text(formatStringDate(dateString));
                                                    $('#disable-day-choice').removeAttr('hidden');
                                                    $('#enable-day-choice').attr('hidden', true);
                                                    $('#dayChoiceModal').modal('show');
                                                }
                                            },
                                            eventDrop: function(info) {
                                                let date = info.event.start;
                                                let dateString = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
                                                let currentDate = new Date();
                                                currentDate.setHours(0, 0, 0, 0);
            
                                                if (date < currentDate) {
                                                    showError('Cannot rebook appointments to a date in the past.');
                                                    info.revert();
                                                    return;
                                                }
            
                                                let disabledDay = disabledDays.find(function(day) {
                                                    return day.date === dateString;
                                                });
            
                                                if (disabledDay && disabledDay.timeOfTheDay === 'whole_day') {
                                                    showError('This date is disabled for the whole day.');
                                                    info.revert();
                                                }
                                                else
                                                {
                                                    if (disabledDay) {
                                                        if (disabledDay.timeOfTheDay === 'morning') {
                                                            $('#id_timeOfTheDay-rebook option[value="morning"]').hide();
                                                            $('#id_timeOfTheDay-rebook').val('afternoon');
                                                        } 
                                                        else if (disabledDay.timeOfTheDay === 'afternoon') {
                                                            $('#id_timeOfTheDay-rebook option[value="afternoon"]').hide();
                                                            $('#id_timeOfTheDay-rebook').val('morning');
                                                        }
                                                    } 
                                                    else {
                                                        $('#id_timeOfTheDay-rebook option[value="morning"]').show();
                                                        $('#id_timeOfTheDay-rebook option[value="afternoon"]').show();
                                                    }
                                                    
                                                    $.ajax({
                                                        type: 'POST',
                                                        url: '{% url "check_if_full" %}',
                                                        data: {
                                                            'selected_date': dateString,
                                                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                                                        },
                                                        success: function(response) {
                                                            if (response.status === 'full') {
                                                                showError('This date is full.');
                                                                info.revert();
                                                            } else {
                                                                info.revert();
                                                                $('#clientName-rebook').text(info.event.extendedProps.client);
                                                                $('#oldDate').text(formatStringDate(info.event.extendedProps.current_date));
                                                                $('#newDate').text(formatStringDate(dateString));
                                                                $('#rebookConfirmAppointmentModal').modal('show');
                                                                var start = info.event.start;
                                                                var dateObj = new Date(start.getTime() - (start.getTimezoneOffset() * 60000));
                                                                var date = dateObj.toISOString().slice(0, 10);
            
                                                                window.eventId = info.event.id;
                                                                window.newDate = date;
            
                                                                var clientId = info.event.extendedProps.client_id;
                                                                var select_pet = $("#id_pet-rebook");
            
                                                                $.ajax({
                                                                    url: "{% url 'get_pets' %}",
                                                                    data: {
                                                                        'client_id': clientId
                                                                    },
                                                                    success: function(data) {
            
                                                                        select_pet.html('');
                                                                        $.each(data, function(index, text) {
                                                                            select_pet.append(
                                                                                $('<option></option>').val(text.id).html(text.name)
                                                                            );
                                                                        });
                                                                        select_pet.val(info.event.extendedProps.pet_id);
                                                                    }
                                                                });
            
                                                                var select_purpose = $("#id_purpose-rebook");
                                                                select_purpose.val(info.event.extendedProps.purpose_id);
            
                                                                var select_timeOfDay = $("#id_timeOfTheDay-rebook");
                                                                // select_timeOfDay.val(info.event.extendedProps.timeOfTheDay_val);
                                                            }
                                                        },
                                                        error: function(error) {
                                                            showError(error.responseJSON.message);
                                                        }
                                                    });
                                                }
                                            },
                                            drop: function(arg) {
                                                let currentDate = new Date();
                                                currentDate.setHours(0, 0, 0, 0);
            
                                                let date = new Date(arg.dateStr + "T00:00:00");
            
                                                if (date < currentDate) {
                                                    showError('Cannot rebook appointments to a date in the past.');
                                                    return;
                                                }
            
                                                let disabledDay = disabledDays.find(function(day) {
                                                    return day.date === arg.dateStr;
                                                });
            
                                                if (disabledDay && disabledDay.timeOfTheDay === 'whole_day') {
                                                    showError('This date is disabled for the whole day.');
                                                }
                                                else
                                                {
                                                    if (disabledDay) {
                                                        if (disabledDay.timeOfTheDay === 'morning') {
                                                            $('#id_timeOfTheDay-rebook option[value="morning"]').hide();
                                                            $('#id_timeOfTheDay-rebook').val('afternoon');
                                                        } else if (disabledDay.timeOfTheDay === 'afternoon') {
                                                            $('#id_timeOfTheDay-rebook option[value="afternoon"]').hide();
                                                            $('#id_timeOfTheDay-rebook').val('morning');
                                                        }
                                                    } else {
                                                        $('#id_timeOfTheDay-rebook option[value="morning"]').show();
                                                        $('#id_timeOfTheDay-rebook option[value="afternoon"]').show();
                                                    }
            
                                                    $.ajax({
                                                        type: 'POST',
                                                        url: '{% url "check_if_full" %}',
                                                        data: {
                                                            'selected_date': arg.dateStr,
                                                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                                                        },
                                                        success: function(response) {
                                                            if (response.status === 'full') {
                                                                showError('This date is full.');
                                                            } else {
                                                                $('#clientName-rebook').text(arg.draggedEl.innerText);
                                                                $('#oldDate').text("From Rebook List");
                                                                $('#newDate').text(arg.dateStr);
                                                                $('#rebookConfirmAppointmentModal').modal('show');
            
                                                                window.eventId = arg.draggedEl.id;
                                                                window.newDate = arg.dateStr;
            
                                                                var clientId = arg.draggedEl.dataset.clientId;
                                                                var petId = arg.draggedEl.dataset.petId;
                                                                var purposeId = arg.draggedEl.dataset.purposeId;
                                                                var timeOfDay = arg.draggedEl.dataset.timeOfDay;
                                                                var url = "{% url 'get_pets' %}";
            
                                                                $.ajax({
                                                                    url: url,
                                                                    data: {
                                                                        'client_id': clientId
                                                                    },
                                                                    success: function(data) {
                                                                        var select = $("#id_pet-rebook");
                                                                        select.html('');
                                                                        $.each(data, function(index, text) {
                                                                            select.append(
                                                                                $('<option></option>').val(text.id).html(text.name)
                                                                            );
                                                                        });
                                                                    }
                                                                });
            
                                                                var select_purpose = $("#id_purpose-rebook");
                                                                select_purpose.val(purposeId);
            
                                                                var select_timeOfDay = $("#id_timeOfTheDay-rebook");
                                                                // select_timeOfDay.val(timeOfDay);
                                                            }
                                                        },
                                                        error: function(error) {
                                                            showError(error.responseJSON.message);
                                                        }
                                                    });
                                                }
                                            },
                                            dayCellClassNames: function(info) {
                                                const eventCounts = getEventCounts(calendar.getEvents());
                                                const date = FullCalendar.formatDate(info.date, {
                                                    timeZone: 'local',
                                                    year: 'numeric',
                                                    month: '2-digit',
                                                    day: '2-digit'
                                                });
            
                                                const parts = date.split('/');
                                                const formattedDate = `${parts[2]}-${parts[0]}-${parts[1]}`;
            
                                                let timeOfDay = null;
                                                let disableDayObject = disabledDays.find(obj => obj.date == formattedDate);
                                                if (disableDayObject) {
                                                    timeOfDay = disableDayObject.timeOfTheDay;
                                                }
            
                                                let slots = dateSlots[formattedDate];
            
                                                if (slots === undefined) {
                                                    slots = maxAppointments;
                                                }
                                                
                                                if (eventCounts[date] === slots || slots === 0) {
                                                    
                                                    return ['day-full'];
                                                } else if (timeOfDay) {
                                                    if (timeOfDay === "morning") {
                                                        return ['day-disabled-morning'];
                                                    } 
                                                    else if (timeOfDay === "afternoon") {
                                                        return ['day-disabled-afternoon']; 
                                                    }
                                                    else if (timeOfDay === "whole_day")
                                                    {
                                                        return ['day-disabled-whole-day'];
                                                    }
                                                } else {
                                                    return ['day-available'];
                                                }
                                            },
                                            dayCellContent: function (arg) {
                                                return {
                                                    html: `${arg.dayNumberText}`
                                                }
                                            },
                                            dayCellDidMount: function(info) {
                                                var date = new Date(info.date);
                                                var today = new Date();
                                                today.setHours(0,0,0,0); 

                                                var formattedDate = date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0') + '-' + date.getDate().toString().padStart(2, '0');

                                                var timeOfTheDayElement = document.createElement('div');
                                                timeOfTheDayElement.style.position = 'absolute';
                                                timeOfTheDayElement.style.left = '5px';
                                                timeOfTheDayElement.style.bottom = '5px'; 
                                                timeOfTheDayElement.style.fontSize = '0.8em';
                                                timeOfTheDayElement.style.zIndex = '1'; 

                                                var slotElement = document.createElement('div');
                                                slotElement.style.position = 'absolute';
                                                slotElement.style.left = '5px';
                                                slotElement.style.top = '5px';
                                                slotElement.style.fontSize = '0.8em';

                                                var eventCountForDate = allAppointments.filter(function(event) {
                                                    var _date = new Date(event.start);
                                                    var _formattedDate = _date.getFullYear() + '-' + (_date.getMonth() + 1).toString().padStart(2, '0') + '-' + _date.getDate().toString().padStart(2, '0');
                                                    return _formattedDate === formattedDate;
                                                }).length;

                                                var slots = dateSlots[formattedDate];

                                                if (slots === undefined) {
                                                    slots = maxAppointments - eventCountForDate;
                                                    slotElement.textContent = `${slots}/${maxAppointments}`;
                                                }
                                                else {
                                                    slots = slots - eventCountForDate;
                                                    slotElement.textContent = `${slots}/${slots + eventCountForDate}`;
                                                }

                                                if (info.el.classList.contains('day-disabled-whole-day')) 
                                                {
                                                    timeOfTheDayElement.textContent = `Disabled`;
                                                }
                                                else if(info.el.classList.contains('day-disabled-morning'))
                                                {
                                                    timeOfTheDayElement.textContent = `Afternoon Available`;
                                                }
                                                else if(info.el.classList.contains('day-disabled-afternoon'))
                                                {
                                                    timeOfTheDayElement.textContent = `Morning Available`;
                                                }
                                                else if (info.el.classList.contains('day-full')) {
                                                    timeOfTheDayElement.textContent = `Full`;
                                                }

                                                if (date < today) {
                                                    slotElement.textContent = ``;
                                                }

                                                info.el.querySelector('.fc-daygrid-day-top').appendChild(slotElement);
                                                info.el.querySelector('.fc-daygrid-day-top').appendChild(timeOfTheDayElement);
                                            },
                                            navLinkDayClick: function(date, jsEvent) {
                                                jsEvent.preventDefault();
            
                                                var events = calendar.getEvents();
                                                var dateStr = date.toISOString();
            
                                                var eventsOnDate = events.filter(function(event) {
                                                    return event.start.toISOString().substring(0, 10) === dateStr.substring(0, 10);
                                                });
            
                                                if (eventsOnDate.length === 0) {
                                                    return;
                                                }
            
                                                $(".appointment-table-title").text(formatDates(date) + ' | Appointments');
                                                $(".appointment-table").removeAttr("hidden");
            
                                                dataTable.rows.remove([0, 1, 2, 3, 4, 5, 6, 7])
            
                                                eventsOnDate.forEach(function(event, index) {
                                                    var row = [
                                                        event.id,
                                                        event.extendedProps.client,
                                                        event.extendedProps.contact_number,
                                                        "<button type='button' class='btn btn-primary btn-sm lift lift-sm' onclick='confirmSendSMS(\"" +
                                                        event.id + "\", \"" +
                                                        event.extendedProps.client + "\", \"" +
                                                        event.extendedProps.contact_number + "\"" +
                                                        ")'>Notify</button>"
                                                    ];
                                                    dataTable.rows.add(row); // Add the row
                                                });
            
                                                $('html, body').animate({
                                                    scrollTop: $(".appointments-list-table").offset().top
                                                }, 100);
                                            },
                                            selectAllow: function(selectInfo) {
                                                var dayBeforeEndDate = new Date(selectInfo.end);
                                                dayBeforeEndDate.setDate(dayBeforeEndDate.getDate() - 1);
                                                return FullCalendar.formatDate(selectInfo.start, {
                                                    timeZone: 'local',
                                                    year: 'numeric',
                                                    month: '2-digit',
                                                    day: '2-digit'
                                                }) === FullCalendar.formatDate(dayBeforeEndDate, {
                                                    timeZone: 'local',
                                                    year: 'numeric',
                                                    month: '2-digit',
                                                    day: '2-digit'
                                                });
                                            },
                                            eventReceive: function(info) {
                                                info.revert();
                                            },
                                        });

                                        $('#addAppointmentModal').on('hidden.bs.modal', function (e) {
                                            $('#id_timeOfTheDay option[value="morning"]').show();
                                            $('#id_timeOfTheDay option[value="afternoon"]').show();
                                            $('#id_timeOfTheDay').val('morning');
                                        });
            
                                        $('#rebookConfirmAppointmentModal').on('hidden.bs.modal', function (e) {
                                            $('#id_timeOfTheDay-rebook option[value="morning"]').show();
                                            $('#id_timeOfTheDay-rebook option[value="afternoon"]').show();
                                            $('#id_timeOfTheDay-rebook').val('morning');
                                        });
                                        
                                        $('#enableDayModal').on('hidden.bs.modal', function (e) {
                                            $('#id_timeOfTheDay option[value="morning"]').show();
                                            $('#id_timeOfTheDay option[value="afternoon"]').show();
                                            $('#id_timeOfTheDay').val('morning');
                                        });
            
                                        $('#yesEnableDayModalButton').click(function(e) {
                                            e.preventDefault();
            
                                            let date = $('#selectedDateToEnable').val();
            
                                            $.ajax({
                                                type: 'POST',
                                                url: '{% url "enable_day" %}',
                                                data: {
                                                    'date': date,
                                                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                                                },
                                                success: function(response) {
                                                    if (response.success) {
                                                        $('#enableDayModal').modal('hide');
                                                        var currentView = calendar.view;
                                                        localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                                                        location.reload();
                                                    }
                                                },
                                                error: function(error) {
                                                    $('#enableDayModal').modal('hide');
                                                    showError(error.responseJSON.message);
                                                }
                                            });
                                        });
            
                                        $('#enable-day-choice').click(function() {
                                            $('#dayChoiceModal').modal('hide');
                                            $('#enableDayModal').modal('show');
                                        });
            
                                        $('#disable-day-choice').click(function() {
                                            $('#dayChoiceModal').modal('hide');
            
                                            let date = window.selectedDate;
                                            let dateString = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            
                                            $('#selectedDateToDisable').val(dateString);
            
                                            $('#disableDayModal').modal('show');
                                        });
            
                                        $('#disableDayForm').on('submit', function(e) {
                                            e.preventDefault();
            
                                            let formData = $(this).serialize();
            
                                            $.ajax({
                                                type: 'POST',
                                                url: '{% url "disable_day" %}',
                                                data: formData,
                                                success: function(response) {
                                                    if (response.status === 'success') {
                                                        $('#disableDayModal').modal('hide');
                                                        var currentView = calendar.view;
                                                        localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                                                        location.reload();
                                                    } else {
                                                        showError(response.message);
                                                    }
                                                },
                                                error: function(error) {
                                                    $('#disableDayModal').modal('hide');
                                                    showError(error.responseJSON.message);
                                                }
                                            });
                                        });
            
                                        $('#adjust-slot-choice').click(function() {
                                            $('#dayChoiceModal').modal('hide');
                                            
                                            let date = window.selectedDate;
                                            let dateString = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            
                                            $('#selectedDateToDisable-slots').val(dateString);
                                            $('#maximum-appointments-allowed').text(maxAppointments);
                                            $('#adjustSlotModal').modal('show');
                                        });
                                        
                                        $('#adjustSlotForm').submit(function(e) {
                                            e.preventDefault();
            
                                            let formData = $(this).serialize();
                                            
                                            $.ajax({
                                                type: 'POST',
                                                url: '{% url "adjust_slots" %}',
                                                data: formData,
                                                success: function(response) {
                                                    if (response.status === 'success') {
                                                        $('#adjustSlotModal').modal('hide');
                                                        var currentView = calendar.view;
                                                        localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                                                        location.reload();
                                                    } else {
                                                        $('#adjustSlotModal').modal('hide');
                                                        showError(response.message);
                                                    }
                                                },
                                                error: function(error) {
                                                    $('#adjustSlotModal').modal('hide');
                                                    showError(error.responseJSON.message);
                                                }
                                            });
                                        });

                                        $('#cancelAdjustSlotModalButton').click(function(e) {
                                            e.preventDefault();
                                            $('#adjustSlotModal').modal('hide');
                                            $('#dayChoiceModal').modal('show');
                                        });

                                        $('#cancelAdjustSlotModalIconButton').click(function(e) {
                                            e.preventDefault();
                                            $('#adjustSlotModal').modal('hide');
                                            $('#dayChoiceModal').modal('show');
                                        });

                                        $('#add-appointment-day-choice').click(function() {
                                            $('#dayChoiceModal').modal('hide');
                                            let date = window.selectedDate;
                                            let dateString = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            
                                            let currentDate = new Date();
                                            currentDate.setHours(0, 0, 0, 0);
            
                                            if (date < currentDate) {
                                                showError('Cannot add appointments in the past.');
                                                return;
                                            }
            
                                            $.ajax({
                                                type: 'POST',
                                                url: '{% url "check_if_full" %}',
                                                data: {
                                                    'selected_date': dateString,
                                                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                                                },
                                                success: function(response) {
                                                    if (response.status === 'full') {
                                                        showError('This date is full.');
                                                    } else {
                                                        $('#selectedDate').val(dateString);
                                                        $('#addAppointmentModal').modal('show');
                                                    }
                                                },
                                                error: function(error) {
                                                    showError(error.responseJSON.message);
                                                }
                                            });
                                        });
            
                                        $('#rebookAppointmentForm').submit(function(e) {
                                            e.preventDefault();
            
                                            var appointment_id = window.eventId;
                                            var new_date = window.newDate;
                                            var time_of_day = $('#id_timeOfTheDay-rebook').val();
                                            var pet = $('#id_pet-rebook').val();
                                            var purpose = $('#id_purpose-rebook').val();
            
                                            $.ajax({
                                                type: 'POST',
                                                url: '{% url "rebook_appointment" %}',
                                                data: {
                                                    'appointment_id': appointment_id,
                                                    'new_date': new_date,
                                                    'time_of_day': time_of_day,
                                                    'pet': pet,
                                                    'purpose': purpose,
                                                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                                                },
                                                success: function(response) {
                                                    if (response.status === 'Appointment rebooked successfully') {
                                                        var draggedEl = document.getElementById(appointment_id);
                                                        if (draggedEl) {
                                                            draggedEl.parentNode.removeChild(draggedEl);
                                                        }
                                                    }
            
                                                    $('#rebookConfirmAppointmentModal').modal('hide');
                                                    var currentView = calendar.view;
                                                    localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                                                    location.reload();
                                                },
                                                error: function(error) {
                                                    $('#rebookConfirmAppointmentModal').modal('hide');
                                                    showError(error.responseJSON.message);
                                                }
                                            });
                                        });
            
            
                                        $('#appointmentForm').on('submit', function(e) {
                                            e.preventDefault();
            
                                            $.ajax({
                                                type: 'POST',
                                                url: '{% url "set_appointment" %}',
                                                data: $(this).serialize(),
                                                success: function(response) {
                                                    if (response.message === 'Appointment created successfully') {
                                                        // var title = $('#id_client option:selected').text();
                                                        // var timeOfDay = $('#id_timeOfTheDay').val();
                                                        // var _color = null;
            
                                                        // if (timeOfDay === 'morning') {
                                                        //     _color = '#3788d8';
                                                        // } else if (timeOfDay === 'afternoon') {
                                                        //     _color = 'green';
                                                        // }
            
                                                        // calendar.addEvent({
                                                        //     title: title,
                                                        //     start: $('#selectedDate').val(),
                                                        //     allDay: true,
                                                        //     color: _color
                                                        // });
            
                                                        calendar.unselect();
                                                        $('#addAppointmentModal').modal('hide');
                                                        var currentView = calendar.view;
                                                        localStorage.setItem('calendarDate', currentView.currentStart.toISOString());
                                                        location.reload();
                                                    }
                                                },
                                                error: function(error) {
                                                    $('#addAppointmentModal').modal('hide');
                                                    showError(error.responseJSON.message);
                                                }
                                            });
                                        });
                                        
                                        calendar.render();
            
                                        var calendarDate = localStorage.getItem('calendarDate');
                                        if (calendarDate) {
                                            calendar.gotoDate(new Date(calendarDate));
                                            localStorage.removeItem('calendarDate');
                                        }
            
                                        function updateCalendarOptions() {
                                            if (window.innerWidth <= 576) {
                                                calendar.setOption('headerToolbar', {
                                                    left: 'title',
                                                    center: 'listMonth,listYear',
                                                    right: 'today prev,next'
                                                });
            
                                            } else {
                                                calendar.setOption('headerToolbar', {
                                                    left: 'today prev,next',
                                                    center: 'title',
                                                    right: 'listDay,dayGridMonth,multiMonthYear,listYear'
                                                });
                                            }
                                        }
            
                                        updateCalendarOptions();
            
                                        function getCurrentDateString() {
                                            const currentDate = new Date();
                                            const year = currentDate.getFullYear();
                                            const month = String(currentDate.getMonth() + 1).padStart(2, '0'); 
                                            const day = String(currentDate.getDate()).padStart(2, '0');
            
                                            return `${year}-${month}-${day}`;
                                        }
                                    },
                                    error: function(error)
                                    {
                                        showError(error.responseJSON.message);
                                    }
                                });
                            },
                            error: function(error)
                            {
                                showError(error.responseJSON.message);
                            }
                        });
                    },
                    error: function(error) {
                        showError(error.responseJSON.message);
                    }
                });

            },
            error: function(error)
            {
                showError(error.responseJSON.message);
            }
        });
    });
</script>
<script>
    $(document).ready(function() {
        $('#id_client').change(function() {
            var url = "{% url 'get_pets' %}";
            var clientId = $(this).val();
            $.ajax({
                url: url,
                data: {
                    'client_id': clientId
                },
                success: function (data) {
                    var select = $("#id_pet");
                    select.html('');
                    $.each(data, function(index, text) {
                        select.append(
                            $('<option></option>').val(text.id).html(text.name)
                        );
                    });
                }
            });
        });
    });
</script>